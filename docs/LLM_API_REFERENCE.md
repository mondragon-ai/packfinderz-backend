## Shared conventions
- Authentication: `Authorization: Bearer <token>` is validated by `middleware.Auth`, loads `user_id`, `store_id`, and `role` into context before entering `/api` handlers (api/middleware/auth.go:23-80).
- Store context: `middleware.StoreContext` rejects requests without a store ID once the JWT is validated (api/middleware/store.go:6-16).
- Roles: `middleware.RequireRole("admin"/"agent")` gates `/api/admin` and `/api/agent` ping endpoints (api/middleware/roles.go:1-27).
- Idempotency: `Idempotency-Key` is required for `POST /api/v1/auth/register`, `/api/v1/stores/me/users/invite`, `/api/v1/licenses`, and `/api/v1/media/presign`, with TTL rules defined in `api/middleware/idempotency.go:37-208`.
- Errors: handlers emit `pkg/errors.Code*` metadata so HTTP status and retryability follow `pkg/errors/errors.go:9-100`.

## Health
- `GET /health/live` – unauthenticated liveliness check, returns `{"status":"live"}` and `X-PackFinderz-Env` (api/controllers/health.go:16-21).
- `GET /health/ready` – dependency probe; pings Postgres/Redis/GCS, surfaces failures via `pkg/errors.CodeDependency` details (api/controllers/health.go:23-70).

## Public
- `GET /api/public/ping` – no auth, responds `{"scope":"public","status":"ok"}` (api/controllers/ping.go:10-24).
- `POST /api/public/validate` – validates `name`/`email` payload, echoes sanitized `name`, `email`, and optional `limit` (validators enforce length/format) (api/controllers/validate.go:11-35).

## Auth
- `POST /api/v1/auth/login` – public, body `{"email","password"}` per `auth.LoginRequest`, returns `auth.LoginResponse` plus `X-PF-Token` (auth.Service.Login) for downstream requests (api/controllers/auth.go:13-36; internal/auth/dto.go:9-29).
- `POST /api/v1/auth/register` – public, body `RegisterRequest` (first/last name, email, password, company, store_type, address, accept_tos), reuses `auth.Service` to auto-login, returns 201 with tokens and `X-PF-Token` (api/controllers/register.go:13-41; internal/auth/register.go:21-133).
- `POST /api/v1/auth/logout` – requires Authorization Bearer token, revokes the access session via `session.Manager.Revoke`, returns `{"status":"logged_out"}` (api/controllers/session.go:47-79).
- `POST /api/v1/auth/refresh` – requires Authorization, body `{"refresh_token"}`, rotates session, issues new `AccessToken`/`RefreshToken` plus `X-PF-Token` header (api/controllers/session.go:81-143).
- `POST /api/v1/auth/switch-store` – Authorization plus body `{"store_id","refresh_token"}`, ensures membership, rotates session, returns new tokens and `StoreSummary` (api/controllers/switch_store.go:18-68).

## Private (store-scoped)
- `GET /api/ping` – auth + store context, echoes scope/store_id for health (api/controllers/ping.go:16-24).

## Cart
- `PUT /api/v1/cart` – buyer stores persist their checkout snapshots via this idempotent (24h TTL) route. `middleware.Idempotency` guards the route and injects the idempotency key, while `controllers.CartUpsert` validates the buyer store is a verified buyer and delegates to `internal/cart.Service.UpsertCart`. The service revalidates vendor subscriptions/KYC, state alignment, inventory + MOQ, volume tier pricing, subtotal/total math, and cart-level discounts before upserting `cart_record`/`cart_items` rows and returning the canonical record with items (`api/middleware/idempotency.go:45-208`; `internal/cart/service.go:1-213`).
- `GET /api/v1/cart` – returns the active cart record (with items) for the buyer store when present. `controllers.CartFetch` reuses the same buyer-store context, calls `internal/cart.Service.GetActiveCart` (which validates the buyer is a verified buyer store and scopes the query to `buyer_store_id`), and surfaces `404`/`pkgerrors.CodeNotFound` if no active cart exists, ensuring only the owning buyer can fetch the snapshot (`internal/cart/service.go:259-284`).

## Checkout
- `POST /api/v1/checkout` – requires auth, store context, and idempotency (`middleware.Idempotency` enforces `Idempotency-Key` for buyer checkout with a 7d TTL and replays the first success while mismatched bodies return `pkg/errors.CodeIdempotency`/HTTP `409`); the handler asserts the store is a buyer (`pkg/errors.CodeForbidden`/HTTP `403` otherwise), decodes `cart_id` plus optional `attributed_ad_click_id`, calls `internal/checkout.Service.Execute`, and returns `201` with `checkout_group_id`, `vendor_orders` grouped by `vendor_store_id` (each order includes `subtotal`, `discount`, `total`, `balance_due`, and its `items` with `status`/`notes`), plus `rejected_vendors` that list every rejected line item so clients can surface failures (`api/controllers/checkout.go:9-145`; `api/middleware/idempotency.go:37-208`).
- `GET /api/v1/orders` – exposes buyer/vendor order lists by reading `activeStoreId`/`StoreType` from the middleware context; buyers call `internal/orders.Repository.ListBuyerOrders`, vendors call `ListVendorOrders` (both wired through `api/controllers/orders.List`), and the handler accepts cursor pagination plus filters (`order_status`, `fulfillment_status`, `shipping_status`, `payment_status`, `actionable_statuses`, `date_from`, `date_to`, `q`, `limit`, `cursor`). Unauthorized store types (missing or unsupported) return `pkg/errors.CodeForbidden`/HTTP `403` (`api/controllers/orders/orders.go:13-144`).
- `GET /api/v1/orders/{orderId}` – calls `internal/orders.Repository.FindOrderDetail`, verifies the returned order’s buyer/vendor store matches `activeStoreId` per the caller’s `StoreType`, and returns 403 when the store does not own the order; 404 is returned when the `orderId` is invalid or not found. The controller parses `order_status` (UUID), handles validation errors, and rejects missing store context before delegating to the repository (`api/controllers/orders/orders.go:146-220`).
- `POST /api/v1/vendor/orders/{orderId}/decision` – vendor-only endpoint (middleware sets `StoreContext`/`StoreType` and `Idempotency-Key`) that accepts `{decision: "accept"|"reject"}` JSON, rejects non-vendor requests/invalid decisions, loads the order, enforces `OrderStatus=created_pending`, transitions it to `accepted`/`rejected`, and emits the `order_decided` outbox event (`api/controllers/orders/orders.go:140-228`; `internal/orders/service.go:24-147`; middleware.StoreContext/logic ensures `Idempotency-Key` per `api/routes/router.go:60-116`).
- `POST /api/v1/vendor/orders/{orderId}/line-items/decision` – vendor-only endpoint (same middleware stack) that accepts `{line_item_id, decision: "fulfill"|"reject", notes?}` JSON, validates the line item belongs to the order, updates its status, releases inventory when rejecting, recomputes `subtotal_cents`, `total_cents`, and `balance_due_cents`, promotes `fulfillment_status`/`status` once every pending line is handled, and emits the `order_fulfilled` outbox event (`api/controllers/orders/orders.go:222-318`; `internal/orders/service.go:180-359`; `pkg/enums/outbox.go:57-72`).
  * `pkg/checkout.ValidateMOQ` still runs as part of the service; each MOQ violation yields `pkg/errors.CodeStateConflict`/HTTP `422` with a `violations` array (`product_id`, optional `product_name`, `required_qty`, `requested_qty`) so callers can point to the offending products before checkout splits the cart (`pkg/checkout/validation.go:11-43`).

## Products
- `GET /api/v1/products` – buyer-facing listing requires `state` (only licensed/subscribed vendors in that state are returned). The controller reuses `pkg/visibility.EnsureVendorVisible` to confirm each vendor store is `kyc_status=verified`, `subscription_active=true`, and its `address.state` matches the requested `state` (plus the buyer store’s state when available); state mismatches yield `pkg/errors.CodeValidation`/HTTP `422`, while hidden vendors return `pkg/errors.CodeNotFound`/HTTP `404`, preventing cross-state or unverified leaks (`pkg/visibility/visibility.go:11-46`).
- `GET /api/v1/products/{productId}` – buyer product detail also applies `pkg/visibility.EnsureVendorVisible` so access to hidden vendors produces `404` regardless of the product ID (same helper contract as above).

## Vendor
- `POST /api/v1/vendor/products` – requires auth, store context, and `Idempotency-Key` (api/middleware/idempotency.go:45-48); body accepts `sku`, `title`, `category`, `unit`, `feelings`, `flavors`, `usage`, inventory quantities, optional `media_ids`, and `volume_discounts`; the controller normalizes enums, validates required fields, and calls `internal/products.Service.CreateProduct`, which ensures the store is a vendor, the caller has one of the allowed store roles, inventory/reserved values make sense, volume discounts have unique `min_qty`, and provided media belong to the same store with `kind=product` before writing the product, inventory, discounts, and media rows in one transaction and returning the created product DTO (api/controllers/products.go:8-206; internal/products/service.go:63-204). Returns `201` on success, `400` for validation failures, `401/403` for auth/role denials, and `409` for conflicts.
- `PATCH /api/v1/vendor/products/{productId}` – requires auth + vendor store context and accepts optional metadata (`sku`, `title`, `subtitle`, `body_html`, `category`, `feelings`, `flavors`, `usage`, `strain`, `classification`, `unit`, `moq`, `price_cents`, `compare_at_price_cents`, `is_active`, `is_featured`, `thc_percent`, `cbd_percent`), plus optional `inventory`, `media_ids`, and `volume_discounts`. Inventory updates must supply both `available_qty` and `reserved_qty` (ints with `reserved_qty ≤ available_qty`), and `media_ids` are deduped while confirming each media record belongs to the same store and has `kind=product`. `controllers.VendorUpdateProduct` normalizes the payload, enforces non-empty trimmed strings, and calls `internal/products.Service.UpdateProduct`, which verifies vendor ownership/roles, ensures unique discount `min_qty`, revalidates the deduped media list, and updates the product, inventory, discounts, and media attachments inside a single transaction before returning the canonical product DTO (api/controllers/products.go:72-205; internal/products/service.go:226-355). Returns `200` on success and `400/401/403/404/409` for validation/auth errors.
- `DELETE /api/v1/vendor/products/{productId}` – requires auth + vendor store context; removes the product row owned by the active store while relying on FK cascades to clean up inventory, discounts, and attached media. `controllers.VendorDeleteProduct` validates the `productId`, store, and user contexts before calling `internal/products.Service.DeleteProduct`, which confirms the store is a vendor, the caller has an allowed role, the product belongs to that store, and then deletes it so inventory, discounts, and product media rows vanish. Returns `204` on success and `400/401/403/404` for canonical failures (api/controllers/products.go:72-244; internal/products/service.go:317-338).

### Stores
- `GET /api/v1/stores/me` – requires active store JWT, returns `stores.StoreDTO` with company, address, owner, KYC, ratings, categories, social links (api/controllers/stores.go:21-48; internal/stores/dto.go:13-105).
- `PUT /api/v1/stores/me` – owner/manager role required, accepts `storeUpdateRequest` (company_name, description, contact, social, banner/logo, ratings, categories), returns updated `StoreDTO` (api/controllers/stores.go:51-124).
- `GET /api/v1/stores/me/users` – owner/manager only, returns `[]memberships.StoreUserDTO` with emails, role/status, last_login (api/controllers/stores.go:126-165; internal/memberships/dto.go:38-76).
- `POST /api/v1/stores/me/users/invite` – owner/manager only, requires `Idempotency-Key`, payload `{"email","first_name","last_name","role"}`, returns invited `StoreUserDTO` plus optional `temporary_password` for new accounts (api/controllers/stores.go:221-302).
- `DELETE /api/v1/stores/me/users/{userId}` – owner/manager only, deletes membership, enforces last-owner guard, returns 200 with empty body (api/controllers/stores.go:168-219).

### Media
- `GET /api/v1/media` – paginated list via optional query `limit`, `kind`, `status`, `mime_type`, `search`, returns `media.ListResult` with signed read URLs for `uploaded`/`ready` items (api/controllers/media.go:134-198; internal/media/list.go:15-139).
- `POST /api/v1/media/presign` – requires `Idempotency-Key`, body `{"media_kind","mime_type","file_name","size_bytes"}`, owner/store check, returns `media.PresignOutput` with `media_id`, `gcs_key`, signed PUT URL, and expiry (api/controllers/media.go:20-91; internal/media/service.go:94-195).
- `DELETE /api/v1/media/{mediaId}` – deletes media if owned, ensures status is deletable, removes GCS object and marks row deleted, returns 204 (api/controllers/media.go:94-132; internal/media/service.go:242-284).

### Licenses
- `POST /api/v1/licenses` – requires `Idempotency-Key`, body includes `media_id`, `issuing_state`, optional dates, `type`, `number`; media must be store-owned, kind `license_doc`, status `uploaded`/`ready`, returns structured license response (api/controllers/licenses.go:21-103; internal/licenses/service.go:51-165).
- `GET /api/v1/licenses` – accepts `limit`/`cursor`, returns `licenses.ListResult` with license metadata + signed GCS download URLs (api/controllers/licenses.go:105-144; internal/licenses/list.go:12-59).

## Admin
- `GET /api/admin/ping` – requires Authorization bearer + role `admin`, share store context if present, no idempotency key required even though idempotency middleware is mounted (api/routes/router.go:64-81; api/controllers/ping.go:26-43).
- `POST /api/v1/admin/licenses/{licenseId}/verify` – admin-only, path parameter parsed as UUID, body `{"decision":"verified|rejected","reason"?}` drives `licenses.Service.VerifyLicense`, which enforces the license is still pending, writes the new status, emits `license_status_changed`, and returns the updated license DTO; invalid decisions or non-pending licenses are rejected with `4xx` errors (api/controllers/licenses.go:233-279; internal/licenses/service.go:382-419).

## Agent
- `GET /api/agent/ping` – requires Authorization + role `agent`, similar to admin ping (api/routes/router.go:83-101; api/controllers/ping.go:36-43).
