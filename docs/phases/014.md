# Jira Ticket

## Title [PF-119]: Create integration test scaffold under `/scripts/integration`

## Type

Infra

## Description

Create a dedicated integration test harness entrypoint that will orchestrate end-to-end API validation using real HTTP calls. This scaffold establishes structure, configuration loading, and execution wiring only.

## Scope

* Create `/scripts/integration/` directory
* Add executable entrypoint script
* Load required environment variables
* Make runnable via `make test`

**NOT included**

* Any domain logic
* Any HTTP calls
* Any assertions beyond config validation

## Acceptance Criteria

* [ ] `make test --[route]` executes the integration entrypoint
* [ ] Script fails fast if required env vars are missing
* [ ] Environment variables are loaded and accessible in code
* [ ] The `--[route]` flag can be things like `login`, `register`, etc

## Dependencies

* Blocked by: None
* Blocks: PF-XXX, PF-XXX, PF-XXX

## Technical Notes

* Required env vars:

  * `API_BASE_URL` 
  * `STORE_PASSWORD` (shared for ALL types: buyer|vendor|agent|admin)
* Emails MAY be inline in scripts; passwords MUST come from env

## Out of Scope

* CI integration
* Parallel execution
* Persistent state

---

# Jira Ticket

## Title [PF-XXX]: Implement shared HTTP client helper for integration scripts

## Type

Task

## Description

Implement a reusable HTTP client utility for integration scripts to standardize request execution, retries, timeouts, JSON handling, and response assertions.

## Scope

* Single helper file
* Base URL handling
* Request retries and timeouts
* JSON encode/decode
* Status code assertions

**NOT included**

* Auth token management
* Domain-specific helpers

## Acceptance Criteria

* [ ] Client supports GET/POST/PUT/DELETE
* [ ] JSON requests and responses handled consistently
* [ ] Non-2xx responses produce readable errors
* [ ] Timeout and retry logic applied uniformly

## Dependencies

* Blocked by: PF-XXX
* Blocks: PF-XXX, PF-XXX, PF-XXX

## Technical Notes

* Location: `/scripts/integration/http_client.*`
* Retry policy SHOULD be deterministic (fixed count)
* **ASSUMPTION:** retries only on network/5xx errors

## Out of Scope

* Circuit breaking
* Rate-limit backoff logic

---

# Jira Ticket

## Title [PF-XXX]: Implement colored JSON console logger for integration output

## Type

Chore

## Description

Create a console logger for integration scripts that outputs structured JSON with colorized fields for human readability while remaining CI-friendly.

## Scope

* Pretty-printed JSON logs
* Colorized keys and status indicators
* Stdout-only logging

**NOT included**

* File logging
* Metrics or tracing
* Business logic

## Acceptance Criteria

* [ ] Logs are human-readable in terminal
* [ ] Logs remain valid JSON when colors disabled
* [ ] Logger is reusable across scripts

## Dependencies

* Blocked by: PF-XXX
* Blocks: PF-XXX, PF-XXX

## Technical Notes

* Colors MUST be optional (env-controlled)
* **ASSUMPTION:** CI disables colors automatically

## Out of Scope

* Log levels beyond info/error
* External log shipping

---

# Jira Ticket

## Title [PF-XXX]: Scripted register flow for buyer and vendor stores

## Type

Feature

## Description

Implement a scripted registration flow that creates buyer and vendor stores via the public API. This validates onboarding end-to-end without DB seeding.

## Scope

* Call registration endpoint
* Support buyer and vendor flags
* Capture and expose:

  * store IDs
  * user IDs
  * access token
  * refresh token

**NOT included**

* License creation
* Subscription activation

## Acceptance Criteria

* [ ] Buyer store is created successfully
* [ ] Vendor store is created successfully
* [ ] Tokens are captured in memory for later steps
* [ ] Failures halt script execution

## Dependencies

* Blocked by: PF-XXX, PF-XXX
* Blocks: PF-XXX, PF-XXX

## Technical Notes

* Endpoint: `POST /api/v1/auth/register`
* Output MUST be machine-readable
* **ASSUMPTION:** registration is enabled in non-prod environments

## Out of Scope

* Email verification
* Duplicate email handling

---

# Jira Ticket

## Title [PF-XXX]: Scripted login flow for buyer and vendor accounts

## Type

Feature

## Description

Implement scripted login flows that authenticate buyer and vendor users using real credentials and capture tokens for subsequent API calls.

## Scope

* Login using email + env-provided password
* Capture access and refresh tokens
* Support buyer and vendor roles

**NOT included**

* MFA flows
* Token refresh logic

## Acceptance Criteria

* [ ] Buyer login succeeds with valid credentials
* [ ] Vendor login succeeds with valid credentials
* [ ] Tokens are stored in memory
* [ ] Invalid credentials fail loudly

## Dependencies

* Blocked by: PF-XXX
* Blocks: PF-XXX

## Technical Notes

* Endpoint: `POST /api/v1/auth/login`
* **ASSUMPTION:** passwords are static for test users

## Out of Scope

* Forgot password
* Account lockout testing

---

# Jira Ticket

## Title [PF-XXX]: In-memory token store and auth header injection helper

## Type

Task

## Description

Implement a shared helper that stores auth tokens in memory and injects them automatically into HTTP requests. Scripts must never manually set Authorization headers.

## Scope

* Token store abstraction
* Automatic header injection
* Role-aware token selection

**NOT included**

* File persistence
* Token refresh

## Acceptance Criteria

* [ ] Tokens persist across script steps
* [ ] No script sets auth headers manually
* [ ] Switching roles updates headers correctly

## Dependencies

* Blocked by: PF-XXX, PF-XXX
* Blocks: PF-XXX, PF-XXX, PF-XXX

## Technical Notes

* Storage is in-memory only
* Tokens MAY be echoed to stdout for debugging
* **ASSUMPTION:** single process execution

## Out of Scope

* Secure secret storage
* Multi-session support

---

# Jira Ticket

## Title [PF-XXX]: Add static media fixtures for integration tests

## Type

Chore

## Description

Add deterministic media fixtures used to validate the full media upload pipeline across product, ads, licenses, and profiles.

## Scope

* Create `fixtures/media/*`
* Include:

  * product/ad images
  * product/ad videos
  * avatar image
  * logo image
  * store banner image
  * COA-like PDF
  * license PDF

**NOT included**

* Large media stress testing
* Dynamic media generation

## Acceptance Criteria

* [ ] All required fixture files exist
* [ ] Files are committed and versioned
* [ ] Fixtures are referenced by scripts

## Dependencies

* Blocked by: None
* Blocks: PF-XXX

## Technical Notes

* PDFs SHOULD resemble real COAs structurally
* **ASSUMPTION:** file sizes remain small for CI

## Out of Scope

* Media compression testing
* Virus scanning

---

# Jira Ticket

## Title [PF-XXX]: Script presigned media upload request and GCS upload

## Type

Feature

## Description

Validate the media pipeline by requesting presigned upload URLs and uploading files directly to GCS using signed URLs.

## Scope

* Call media create endpoint
* Capture `media_id` + signed URL
* Upload file via PUT
* Store media IDs for later steps

**NOT included**

* Polling
* Media reuse

## Acceptance Criteria

* [ ] Presigned URL request succeeds
* [ ] File uploads successfully to GCS
* [ ] media_id is captured and reused

## Dependencies

* Blocked by: PF-XXX, PF-XXX
* Blocks: PF-XXX

## Technical Notes

* Endpoint: `POST /api/v1/media`
* Upload via HTTP PUT
* **ASSUMPTION:** GCS credentials already configured

## Out of Scope

* Multipart uploads
* Resumable uploads

---

# Jira Ticket

## Title [PF-XXX]: Poll media status until uploaded

## Type

Task

## Description

Poll the media status endpoint until uploaded or timeout to ensure downstream scripts only operate on valid media IDs.

## Scope

* Poll media status endpoint
* Timeout handling
* Block downstream execution until success

**NOT included**

* Event-driven callbacks
* Exponential backoff

## Acceptance Criteria

* [ ] Polling stops on success
* [ ] Timeout fails the script clearly
* [ ] No downstream step runs with invalid media

## Dependencies

* Blocked by: PF-XXX
* Blocks: PF-XXX

## Technical Notes

* Endpoint: `GET /api/v1/media/{id}`
* **ASSUMPTION:** status transitions include `uploaded`

## Out of Scope

* Media processing validation

---

# Jira Ticket

## Title [PF-XXX]: Script full domain happy-path (license → product → checkout → payout)

## Type

Feature

## Description

Implement a linear, dependency-aware script that validates the complete marketplace happy path: compliance, commerce, fulfillment, and payout.

## Scope

* Create license using media
* Admin approve/reject license
* Create product with gallery + COA
* Add to cart → checkout → order
* Agent deliver
* Admin payout confirmation

**NOT included**

* Failure scenarios
* Partial fulfillment
* Refunds

## Acceptance Criteria

* [ ] License starts as `pending`
* [ ] Admin approval unblocks product visibility
* [ ] Product becomes purchasable
* [ ] Order completes end-to-end
* [ ] Vendor payout succeeds

## Dependencies

* Blocked by: PF-XXX
* Blocks: None

## Technical Notes

* Uses real APIs only
* Validates money flow correctness
* **ASSUMPTION:** happy-path only for Phase 13

## Out of Scope

* Edge cases
* Load testing
