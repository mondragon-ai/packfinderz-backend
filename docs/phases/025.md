# Title [PF-217]: Implement cart attribution token pass-through

## Type

Feature

## Description

Implement pass-through handling for a cart attribution token to preserve upstream attribution context (e.g., `ad_tokens` ->  `[]string` from `QuoteCartRequest`). The service must validate token signature and expiry only, persist it on the cart record, and echo it back in cart quote responses without interpreting its contents. if not a valid JWT token and or expired or unverified ommit from the cart completey adn repsonse. No warning or message needs to be echoed to the client.

## Scope

* Accept attribution token on cart create/update
* Validate token signature and expiry (valid JWT)
* Persist token on `cart_records`
* Echo token in CartQuote response DTO

**Explicitly NOT included**

* Attribution business logic
* Token generation
* Analytics processing of the token

## Acceptance Criteria

* [ ] Invalid or expired attribution tokens are rejected
* [ ] Valid tokens are persisted on the cart record
* [ ] CartQuote responses include the same attribution token
* [ ] Token contents are not modified or interpreted

## Dependencies

* Blocked by: Cart records table/model
* Blocks: PF-219

## Technical Notes

* Token validation should be a lightweight verifier (signature + exp)
* Storage field: `cart_records.ad_tokens` (`pq.StringArray`)
* **ASSUMPTION:** token format and signing key are already defined elsewhere

## Out of Scope

* Attribution analytics
* Token refresh or regeneration

---

# Title [PF-218]: Enforce cart quote `valid_until` expiration guardrail

## Type

Feature

## Description

Enforce a strict expiration window for cart quotes. If a cart quote is expired, clients must re-quote before proceeding to checkout. This ensures pricing and availability remain accurate.

## Scope

* Add `valid_until` to cart quote responses
* Enforce expiration at checkout initiation
* Require re-quote if `valid_until` has passed
* Default validity window: 15 minutes from quote generation/update/upsert

**Explicitly NOT included**

* Automatic re-quoting
* Client-side timers

## Acceptance Criteria

* [ ] Cart quotes include a `valid_until` timestamp
* [ ] Checkout attempts with expired quotes are rejected
* [ ] Re-quoting refreshes `valid_until`
* [ ] Non-expired quotes proceed normally

## Dependencies

* Blocked by: Cart quote service
* Blocks: PF-219

## Technical Notes

* Validation should occur server-side at checkout
* **ASSUMPTION:** system time is authoritative and consistent

## Out of Scope

* Grace periods
* Partial quote refresh

---

# Title [PF-219]: Implement cart conversion readiness and converted-cart guardrails

## Type

Feature

## Description

Introduce explicit cart lifecycle transitions to mark carts as converted once they are used for checkout. Persist a `checkout_group_id` at conversion time and prevent invalid future mutations of converted carts.

## Scope

* Add cart state transition: `active` → `converted`
* Generate and persist `checkout_group_id` on conversion
* Enforce guardrails to reject quote upserts on converted carts (if enabled)
* Ensure idempotent conversion behavior

**Explicitly NOT included**

* Order creation logic
* Cart archival or deletion

## Acceptance Criteria

* [ ] Cart transitions to `converted` exactly once
* [ ] `checkout_group_id` is generated and persisted
* [ ] Converted carts cannot be re-quoted or mutated
* [ ] Repeated conversion attempts are idempotent

## Dependencies

* Blocked by: PF-217, PF-218
* Blocks: None

## Technical Notes

* State stored on `cart_records.status`
* `checkout_group_id` must be stable across retries
* **ASSUMPTION:** conversion occurs at checkout initiation

## Out of Scope

* Multi-checkout per cart
* Cart cloning behavior

---

# [INCOMPLETE ❌] Title [PF-220]: Add rate limiting for `POST /cart`

## Type

Infra

## Description

Add rate limiting to the cart creation/update endpoint to protect against abuse and accidental flooding, ensuring system stability and predictable load.

## Scope

* Apply rate limiting to `POST /cart`
* Define reasonable per-client limits
* Return standard rate-limit errors when exceeded

**Explicitly NOT included**

* Rate limiting on other endpoints
* Dynamic per-user tuning

## Acceptance Criteria

* [ ] Requests exceeding the limit are rejected with 429
* [ ] Legitimate traffic within limits is unaffected
* [ ] Limits are configurable

## Dependencies

* Blocked by: Existing middleware or gateway support
* Blocks: None

## Technical Notes

* Likely implemented via middleware or gateway (e.g., Redis-backed)
* **ASSUMPTION:** client identity is derived from auth/session or IP

## Out of Scope

* Adaptive throttling
* Abuse detection

---

# Title [PF-221]: Implement cart quote mapping helpers with unit tests

## Type

Task

## Description

Create explicit mapping helpers to convert between database models, domain objects, and DTOs for cart quotes. This reduces duplication and ensures consistent transformations.

## Scope

* Implement mapping helpers:

  * DB → domain
  * domain → DTO
  * DTO → domain (if applicable)
* Add unit tests covering all mappings

**Explicitly NOT included**

* Business logic changes
* Integration tests

## Acceptance Criteria

* [ ] Mapping helpers cover all cart quote fields
* [ ] Unit tests validate round-trip correctness
* [ ] Existing code uses helpers instead of ad-hoc mapping

## Dependencies

* Blocked by: Cart quote domain model
* Blocks: PF-222

## Technical Notes

* Location: cart quote service or shared mapper package
* **ASSUMPTION:** mapping logic is deterministic and side-effect free

## Out of Scope

* Performance optimizations
* Serialization format changes

---

# [INCOMPLETE ❌] Title [PF-222]: Add structured logs and metrics to cart quote service

## Type

Chore

## Description

Add structured logging and basic metrics to the cart quote service to improve observability, diagnose issues, and measure usage patterns.

## Scope

* Add structured logs for:

  * quote creation
  * quote refresh
  * expiration warnings
* Emit metrics:

  * quote count
  * quote duration
  * expiration/rejection counts

**Explicitly NOT included**

* Dashboards or alerts
* Distributed tracing

## Acceptance Criteria

* [ ] Logs include cart ID, store ID, and timestamps
* [ ] Metrics are emitted for each quote operation
* [ ] No sensitive data is logged

## Dependencies

* Blocked by: PF-221
* Blocks: None

## Technical Notes

* Use existing logging/metrics framework
* **ASSUMPTION:** metrics backend is already configured

## Out of Scope

* SLO definitions
* Alerting policies
