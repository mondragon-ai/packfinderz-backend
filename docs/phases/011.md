## **Title [PF-106]: Create `notifications` table and indexes**

## **Type**

Infra

## **Description**

Create the `notifications` table to support in-app notifications scoped to a store. This table enables durable, queryable notifications without client-side polling loops and supports unread tracking and TTL cleanup.

## **Scope**

* Create `notifications` table per Master Context
* Add required indexes for efficient querying
* Enforce store-scoped ownership

## **Acceptance Criteria**

* [ ] `notifications` table exists with required columns
* [ ] Index exists on `(store_id, created_at DESC)`
* [ ] Index exists on `(store_id, read_at)`
* [ ] Index exists on `(created_at)` for TTL cleanup

## **Dependencies**

* Blocked by: None
* Blocks: PF-1XX, PF-1XX, PF-1XX

## **Technical Notes**

* Table shape (authoritative):

  * `id (uuid, pk)`
  * `store_id (uuid, fk â†’ stores.id)`
  * `type (notification_type enum)`
  * `title (text)`
  * `message (text)`
  * `link (text, nullable)`
  * `read_at (timestamptz, nullable)`
  * `created_at (timestamptz)`
* FK MUST be `ON DELETE CASCADE`
* **ASSUMPTION:** no per-user notifications in MVP; notifications are store-scoped

## **Out of Scope**

* Push notifications
* Email/SMS delivery

---

## **Title [PF-107]: Implement notifications repository and service layer**

## **Type**

Task

## **Description**

Add repository and service helpers to list and update notifications in a consistent, store-scoped manner. This layer abstracts pagination, unread filtering, and read state transitions.

## **Scope**

* Repository functions for querying notifications
* Service functions for marking notifications read
* Cursor-based pagination support

## **Acceptance Criteria**

* [ ] Repo supports listing notifications by `store_id`
* [ ] Repo supports unread-only filtering
* [ ] Service exposes methods used by API controllers

## **Dependencies**

* Blocked by: PF-1XX
* Blocks: PF-1XX, PF-1XX, PF-1XX

## **Technical Notes**

* Location:

  * Repo: `internal/notifications/repo`
  * Service: `internal/notifications/service`
* Pagination MUST use cursor (`created_at`, `id`) ordering
* **ASSUMPTION:** page size defaults to 25, max 100

## **Out of Scope**

* Notification creation logic (emitted elsewhere via workers)
* Real-time delivery mechanisms

---

## **Title [PF-1XX]: List in-app notifications endpoint**

## **Type**

Feature

## **Description**

Expose an authenticated endpoint for clients to fetch in-app notifications for the active store, with support for unread filtering and cursor-based pagination.

## **Scope**

* Implement `GET /api/v1/notifications`
* Enforce store scoping via `activeStoreId`
* Support query params:

  * `unreadOnly=true|false`
  * `limit`
  * `cursor`

## **Acceptance Criteria**

* [ ] Endpoint returns notifications scoped to active store only
* [ ] `unreadOnly=true` returns only unread notifications
* [ ] Response includes `items[]` and `nextCursor`
* [ ] Non-authenticated requests return 401

## **Dependencies**

* Blocked by: PF-1XX, PF-1XX
* Blocks: None

## **Technical Notes**

* Controller: `api/controllers/notifications`
* Ordering: newest first
* **ASSUMPTION:** no role-based filtering beyond store membership

## **Out of Scope**

* Marking notifications read
* Server-side aggregation or counts endpoint

---

## **Title [PF-1XX]: Mark single notification as read**

## **Type**

Feature

## **Description**

Allow a client to mark an individual notification as read. The operation must be idempotent to safely support retries.

## **Scope**

* Implement `POST /api/v1/notifications/{id}/read`
* Update `read_at` timestamp if not already set
* Enforce store ownership

## **Acceptance Criteria**

* [ ] First call sets `read_at`
* [ ] Subsequent calls return success without changing state
* [ ] Cannot mark notifications belonging to another store
* [ ] Endpoint requires Idempotency-Key

## **Dependencies**

* Blocked by: PF-1XX
* Blocks: None

## **Technical Notes**

* Update must be conditional: `WHERE read_at IS NULL`
* Use canonical idempotency middleware
* **ASSUMPTION:** response payload is empty or minimal success envelope

## **Out of Scope**

* Bulk updates
* Notification deletion

---

## **Title [PF-1XX]: Mark all notifications as read**

## **Type**

Feature

## **Description**

Provide a bulk endpoint to mark all unread notifications for the active store as read. This endpoint must be idempotent and efficient.

## **Scope**

* Implement `POST /api/v1/notifications/read-all`
* Set `read_at` on all unread notifications for store

## **Acceptance Criteria**

* [ ] All unread notifications are marked read in one operation
* [ ] Repeated calls are safe and return success
* [ ] Only affects notifications for active store

## **Dependencies**

* Blocked by: PF-1XX
* Blocks: None

## **Technical Notes**

* Single UPDATE statement preferred
* Must be wrapped in transaction
* **ASSUMPTION:** no per-notification audit log required

## **Out of Scope**

* Partial read (by type or date)
* User-level read state

---

## **Title [PF-1XX]: Notification TTL cleanup scheduler**

## **Type**

Task

## **Description**

Implement a scheduled cleanup job to delete notifications older than 30 days to keep the table bounded and performant.

## **Scope**

* Scheduler job executed daily
* Delete notifications with `created_at < now() - 30 days`

## **Acceptance Criteria**

* [ ] Notifications older than 30 days are deleted
* [ ] Job is idempotent and safe to rerun
* [ ] Failure is logged and observable

## **Dependencies**

* Blocked by: PF-1XX
* Blocks: None

## **Technical Notes**

* Implement in worker scheduler loop
* SQL reference:

  ```sql
  DELETE FROM notifications
  WHERE created_at < now() - interval '30 days';
  ```
* **ASSUMPTION:** no archival required in MVP

## **Out of Scope**

* Configurable retention periods
* Soft deletes or exports
