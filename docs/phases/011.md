## **Title [PF-106]: Create `notifications` table and indexes**

## **Type**

Infra

## **Description**

Create the `notifications` table to support in-app notifications scoped to a store. This table enables durable, queryable notifications without client-side polling loops and supports unread tracking and TTL cleanup.

## **Scope**

* Create `notifications` table per Master Context
* Add required indexes for efficient querying
* Enforce store-scoped ownership

## **Acceptance Criteria**

* [ ] `notifications` table exists with required columns
* [ ] Index exists on `(store_id, created_at DESC)`
* [ ] Index exists on `(store_id, read_at)`
* [ ] Index exists on `(created_at)` for TTL cleanup

## **Dependencies**

* Blocked by: None
* Blocks: PF-1XX, PF-1XX, PF-1XX

## **Technical Notes**

* Table shape (authoritative):

  * `id (uuid, pk)`
  * `store_id (uuid, fk → stores.id)`
  * `type (notification_type enum)`
  * `title (text)`
  * `message (text)`
  * `link (text, nullable)`
  * `read_at (timestamptz, nullable)`
  * `created_at (timestamptz)`
* FK MUST be `ON DELETE CASCADE`
* **ASSUMPTION:** no per-user notifications in MVP; notifications are store-scoped

## **Out of Scope**

* Push notifications
* Email/SMS delivery

---

## **Title [PF-107]: Implement notifications repository and service layer**

## **Type**

Task

## **Description**

Add repository and service helpers to list and update notifications in a consistent, store-scoped manner. This layer abstracts pagination, unread filtering, and read state transitions.

## **Scope**

* Repository functions for querying notifications
* Service functions for marking notifications read
* Cursor-based pagination support

## **Acceptance Criteria**

* [ ] Repo supports listing notifications by `store_id`
* [ ] Repo supports unread-only filtering
* [ ] Service exposes methods used by API controllers

## **Dependencies**

* Blocked by: PF-1XX
* Blocks: PF-1XX, PF-1XX, PF-1XX

## **Technical Notes**

* Location:

  * Repo: `internal/notifications/repo`
  * Service: `internal/notifications/service`
* Pagination MUST use cursor (`created_at`, `id`) ordering
* **ASSUMPTION:** page size defaults to 25, max 100

## **Out of Scope**

* Notification creation logic (emitted elsewhere via workers)
* Real-time delivery mechanisms

---

## **Title [PF-108]: List in-app notifications endpoint**

## **Type**

Feature

## **Description**

Expose an authenticated endpoint for clients to fetch in-app notifications for the active store, with support for unread filtering and cursor-based pagination. This in theory should NOT use pagination. Ideally the list pulled is only relevant notificatonas and the TTL scheduler that celans notifications will clean up old ones > 30d. Add just in case though 

## **Scope**

* Implement `GET /api/v1/notifications`
* Enforce store scoping via `activeStoreId`
* Support query params:

  * `unreadOnly=true|false`
  * `limit`
  * `cursor`

## **Acceptance Criteria**

* [x] Endpoint returns notifications scoped to active store only
* [x] `unreadOnly=true` returns only unread notifications
* [x] Response includes `items[]` and `nextCursor`
* [x] Non-authenticated requests return 401

## **Dependencies**

* Blocked by: PF-1XX, PF-1XX
* Blocks: None

## **Technical Notes**

* Controller: `api/controllers/notifications`
* Ordering: newest first
* **ASSUMPTION:** no role-based filtering beyond store membership

## **Out of Scope**

* Marking notifications read
* Server-side aggregation or counts endpoint

---

## **Title [PF-109]: Mark notifications as read (single + bulk)**

## **Type**

Feature

## **Description**

Implement idempotent endpoints to mark notifications as read, supporting both single-notification updates and bulk “mark all as read” for the active store. These operations share nearly identical semantics and should reuse the same repository/service logic to ensure consistency and simplicity.

## **Scope**

* Implement `POST /api/v1/notifications/{id}/read`
* Implement `POST /api/v1/notifications/read-all`
* Update `read_at` timestamp only when currently `NULL`
* Enforce store ownership via `activeStoreId`
* Ensure both endpoints are idempotent and retry-safe

## **Acceptance Criteria**

* [x] Single endpoint sets `read_at` on first call and is a no-op on subsequent calls
* [x] Bulk endpoint sets `read_at` on all unread notifications for the active store
* [x] Repeated calls to either endpoint return success without changing state
* [x] Notifications from other stores cannot be modified
* [x] Both endpoints require `Idempotency-Key`

## **Dependencies**

* Blocked by: Notifications repo/service availability
* Blocks: None

## **Technical Notes**

* Controllers:

  * `POST /api/v1/notifications/{id}/read`
  * `POST /api/v1/notifications/read-all`
* Shared service method SHOULD handle:

  * store scoping
  * conditional update (`read_at IS NULL`)
* SQL patterns:

  * Single:

    ```sql
    UPDATE notifications
    SET read_at = now()
    WHERE id = :id
      AND store_id = :store_id
      AND read_at IS NULL;
    ```
  * Bulk:

    ```sql
    UPDATE notifications
    SET read_at = now()
    WHERE store_id = :store_id
      AND read_at IS NULL;
    ```
* Must use canonical idempotency middleware
* **ASSUMPTION:** response payload is an empty or minimal success envelope
* **ASSUMPTION:** no audit log entries required for read acknowledgments

## **Out of Scope**

* Partial read operations (by type, date, or filter)
* Notification deletion
* User-level (per-user) read state

---

## **Title [PF-1XX]: Notification TTL cleanup scheduler**

## **Type**

Task

## **Description**

Implement a scheduled cleanup job to delete notifications older than 30 days to keep the table bounded and performant.

## **Scope**

* Scheduler job executed daily
* Delete notifications with `created_at < now() - 30 days`

## **Acceptance Criteria**

* [ ] Notifications older than 30 days are deleted
* [ ] Job is idempotent and safe to rerun
* [ ] Failure is logged and observable

## **Dependencies**

* Blocked by: PF-1XX
* Blocks: None

## **Technical Notes**

* Implement in worker scheduler loop
* SQL reference:

  ```sql
  DELETE FROM notifications
  WHERE created_at < now() - interval '30 days';
  ```
* **ASSUMPTION:** no archival required in MVP

## **Out of Scope**

* Configurable retention periods
* Soft deletes or exports
