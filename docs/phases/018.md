# Title [PF-XXX]: Finalize `cmd/outbox-publisher` dispatcher binary

## Type

Infra

## Description

Finalize the `cmd/outbox-publisher` binary that continuously dispatches authoritative Postgres outbox events to Pub/Sub. This binary acts as a **pure transport and safety layer**, with no business logic, enforcing the canonical dispatcher control flow defined in the master context.

## Scope

* Implement main dispatcher loop
* Fetch unpublished outbox rows using `FOR UPDATE SKIP LOCKED`
* Process rows sequentially within a batch
* Sleep with jitter between polling cycles
* Structured logging per attempt

**Explicitly NOT included**

* Cron semantics or scheduling guarantees
* Domain-specific decisions
* Pub/Sub consumer logic

## Acceptance Criteria

* [ ] Binary builds and runs independently as `cmd/outbox-publisher`
* [ ] Dispatcher fetches only `published_at IS NULL` rows
* [ ] Rows are locked using `FOR UPDATE SKIP LOCKED`
* [ ] Each row is processed exactly once per loop iteration
* [ ] Failure of one row does not halt the dispatcher

## Dependencies

* Blocked by: `outbox_events` table exists
* Blocks: PF-XXX, PF-XXX, PF-XXX, PF-XXX

## Technical Notes

* Entry points:

  * `cmd/outbox-publisher/main.go`
  * `cmd/outbox-publisher/service.go`
* Batch size SHOULD be configurable
* Sleep jitter prevents thundering herd
* **ASSUMPTION:** at-least-once semantics are acceptable and expected

## Out of Scope

* Horizontal scaling coordination
* Leader election
* Backpressure from consumers

---

# Title [PF-XXX]: Implement event → topic routing registry with typed payload validation

## Type

Feature

## Description

Implement a centralized, explicit registry that maps `event_type` → Pub/Sub topic and validates typed payloads per event before publishing. This enforces schema correctness and prevents malformed events from leaving the system.

## Scope

* Central switch/map for event → topic routing
* Typed payload structs per `event_type`
* Decode and validate payload **before** publish
* Fail fast on unknown event types

**Explicitly NOT included**

* Dynamic or config-driven routing
* Backward-compatible payload coercion

## Acceptance Criteria

* [ ] Known `event_type` routes to exactly one topic
* [ ] Unknown `event_type` is treated as non-retryable failure
* [ ] Payload is decoded into the correct struct before publish
* [ ] Validation failure results in DLQ (not retry)
* [ ] Payload is always present (may be `{}` but not null)

## Dependencies

* Blocked by: PF-XXX
* Blocks: PF-XXX

## Technical Notes

* Location:

  * `pkg/outbox/registry`
  * `pkg/outbox/payloads`
* Canonical mappings MUST match master context
* Validation occurs prior to envelope construction
* **ASSUMPTION:** payload structs are versioned in code, not DB

## Out of Scope

* Schema evolution tooling
* Multiple versions per event type

---

# Title [PF-XXX]: Define retry policy and attempt handling for outbox publishing

## Type

Task

## Description

Implement bounded retry behavior for outbox publishing failures. The dispatcher must distinguish retryable vs non-retryable failures and update attempt counters and error metadata accordingly.

## Scope

* Classify failures as retryable vs non-retryable
* Increment `attempts` only after failed publish
* Persist `last_error` with short reason
* Enforce `MAX_ATTEMPTS` cutoff

**Explicitly NOT included**

* Pub/Sub internal retry logic
* Exponential retry inside Pub/Sub client

## Acceptance Criteria

* [ ] Retryable failures increment `attempts`
* [ ] Non-retryable failures do not retry
* [ ] Events exceeding `MAX_ATTEMPTS` are terminal
* [ ] Dispatcher never marks published without Pub/Sub ack

## Dependencies

* Blocked by: PF-XXX
* Blocks: PF-XXX

## Technical Notes

* Config:

  * `MAX_ATTEMPTS = 10` (configurable)
* Retryable examples:

  * transient network errors
  * Pub/Sub timeouts
* Non-retryable examples:

  * unknown event_type
  * payload decode failure
* **ASSUMPTION:** attempt count is authoritative for terminal state

## Out of Scope

* Dynamic retry tuning
* Per-event retry policies

---

# Title [PF-XXX]: Implement DLQ model, migration, and repository

## Type

Infra

## Description

Introduce a first-class Dead Letter Queue (DLQ) persistence model to capture terminal outbox failures. DLQ rows preserve the original event envelope and error context for inspection and manual remediation.

## Scope

* Create `outbox_dlq` table migration
* Define DLQ model and repository helpers
* Persist DLQ rows atomically with terminal outbox state

**Explicitly NOT included**

* Automatic reprocessing
* Admin UI for DLQ inspection

## Acceptance Criteria

* [ ] `outbox_dlq` table exists with required columns
* [ ] DLQ rows store original envelope payload
* [ ] DLQ write is atomic with terminal outbox update
* [ ] DLQ rows are never retried automatically

## Dependencies

* Blocked by: PF-XXX
* Blocks: PF-XXX

## Technical Notes

* Table: `outbox_dlq`
* Fields MUST match master context spec
* Repo location: `pkg/outbox/dlq_repository.go`
* **ASSUMPTION:** DLQ retention is handled separately (cron cleanup)

## Out of Scope

* DLQ replay tooling
* Metrics dashboards

---

# Title [PF-XXX]: Publish to DLQ on terminal outbox failure

## Type

Feature

## Description

Integrate DLQ publishing into the dispatcher control flow. When an outbox event reaches a terminal failure state (non-retryable error or max attempts exceeded), the dispatcher must write a DLQ row and mark the outbox event as terminal.

## Scope

* Detect terminal failure conditions
* Construct original event envelope for DLQ
* Write DLQ row
* Prevent further processing of the outbox row

**Explicitly NOT included**

* DLQ reprocessing
* Notifications or alerts on DLQ write

## Acceptance Criteria

* [ ] Non-retryable failures result in DLQ write
* [ ] Events exceeding `MAX_ATTEMPTS` result in DLQ write
* [ ] Outbox row is not retried after DLQ
* [ ] DLQ payload matches original envelope exactly

## Dependencies

* Blocked by: PF-XXX, PF-XXX, PF-XXX
* Blocks: None

## Technical Notes

* DLQ write MUST occur before marking outbox terminal
* Envelope fields MUST mirror publish envelope
* **ASSUMPTION:** “terminal” means `published_at` remains NULL and row is excluded by dispatcher

## Out of Scope

* Alerting on DLQ growth
* Partial DLQ writes
