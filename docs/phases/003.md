

[DONE ✅]
## Title [PF-053]: Media list endpoint (store-scoped, filterable, paginated)

## Type

Feature

## Description

Implement a **read-only media listing endpoint** that allows clients to fetch media owned by the active store. This enables media reuse (licenses, COAs, banners, profile images) without re-uploading files. 

This endpoint is foundational for all future “attach existing media” UX flows. 

This endpoint will utilize the `SignedReadURL` function from our `pkg/storage/gcs/client.go` GCS client. We must batch all the files to save CPU bandwidth and costs. We will use react query to cache the request and reqfetch after 30 min (as per the `PACKFINDERZ_GCS_DOWNLOAD_URL_EXPIRY` var). 

## Scope

* Store-scoped media listing (`media.store_id = activeStoreId`)
* Filter by:

  * `kind` (product, ads, pdf, license_doc, coa, manifest)
  * `status`
  * `mime_type`
  * optional text search on `file_name`
* Cursor-based pagination (canonical API rules)
* Returns **metadata only** (no signed URLs)

## Acceptance Criteria

* [ ] `GET /api/v1/media` returns only media owned by `activeStoreId`
* [ ] Supports filters: `kind`, `status`, `search`, `mime_type`
* [ ] Pagination via `limit` + `cursor`
* [ ] Response uses canonical success envelope
* [ ] Unauthorized access to other stores’ media is impossible
* [ ] In addition to the row data from the Media table we need to add another field to our response DTO which is the signed URL. 

## Dependencies

* Blocked by: none
* Blocks: PF-055 (read URL generation), UI media picker

## Technical Notes

* Table: `media`
* Endpoint: `GET /api/v1/media`
* Enforce RBAC: any store member role allowed
* Do NOT include `gcs_key` directly unless already defined as safe metadata (current spec allows it)

## Out of Scope

* Signed URLs
* Media attachment logic
* Cross-store/admin listing

---


[DONE ✅]
## Title [PF-054]: Media delete endpoint (safe, reference-aware)

## Type

Feature

## Description

Implement a **media deletion endpoint** that safely deletes media only when it is no longer referenced. This prevents accidental removal of licenses, COAs, or manifests still in use. 

## Scope

* Trigger object deletion in GCS (idempotent)
* Store audit-safe metadata (timestamps, status)

## Acceptance Criteria

* [ ] `DELETE /api/v1/media/{mediaId}` enforces store ownership
* [ ] Rejects deletion if media is still attached (`409`)
* [ ] Successfully deletes unreferenced media
* [ ] GCS object is removed (or already missing tolerated)
* [ ] Idempotent behavior on repeat calls

## Dependencies

* Blocked by: GCP Set up
* Blocks: PF-053

## Technical Notes

* Tables: `media`
* Endpoint: `DELETE /api/v1/media/{mediaId}`
* Use canonical errors (`409 CONFLICT` when attached)
* **ASSUMPTION:** Hard delete allowed for now if not referenced in licenses, COAs, or manifests ( we will handle that more thoroughly with media_attachment tables later).
* **ASSUMPTION:** We will impliment media attachemnt much later to make the deeleting process more sophisticated


## Out of Scope

* Cascading detach logic
* Admin override delete

---


[DONE ✅]
## Title [PF-055]: Presigned READ URL generation (TTL-based)

## Type

Feature

## Description

Provide a secure way to **generate short-lived signed READ URLs** for private media stored in GCS. This allows clients to preview/download files without exposing the bucket. 

## Scope

* Generate signed GET URLs with configurable TTL
* Validate store ownership of media
* Enforce media status (`uploaded|ready` only)
* This is only a helper function that will be used to generate read URLs with TTL of `PACKFINDERZ_GCS_DOWNLOAD_URL_EXPIRY`


## Acceptance Criteria

* [ ] URL expires based on config (e.g. 15-30 min)
* [ ] Access denied if media does not belong to active store
* [ ] Media in invalid state is rejected (`409` or `422`)
* [ ] Helper function that take the key from the object (media, product, order, etc) and used GCS to generate readable URLs

## Dependencies

* Blocked by: PF-053
* Blocks: UI preview/download flows

## Technical Notes

* Uses `pkg/storage/gcs`
* No DB writes required
* **ASSUMPTION:** TTL configured via `PACKFINDERZ_GCS_DOWNLOAD_URL_EXPIRY`

## Out of Scope

* Public URLs
* Batch URL generation

---

## Title [PF-056]: Media attachment model (polymorphic, future)

## Type

Task

## Description

Define and formalize the **media attachment abstraction** that allows media to be reused across multiple domain entities (products, licenses, ads, orders).

This ticket is schema + helper preparation only.

## Scope

* Confirm `media_attachments` table usage
* Define canonical `entity_type` values
* Create repo helpers for attach/detach (unused for now)

## Acceptance Criteria

* [ ] Attachment model documented and validated
* [ ] Repo helpers exist but are unused
* [ ] No behavior change in API

## Dependencies

* Blocked by: none
* Blocks: PF-057

## Technical Notes

* Table: `media_attachments`
* **ASSUMPTION:** Polymorphic FK enforced at app layer only

## Out of Scope

* Enforcing attachment rules
* UI usage

---

## Title [PF-057]: Media attach enforcement helpers (future)

## Type

Task

## Description

Introduce **shared enforcement helpers** that validate whether a given media item can be attached to a specific domain entity (e.g. COA → product, license_doc → license).

This is groundwork only.

## Scope

* Central validation helpers (no routes)
* Media-kind × owner-type compatibility rules

## Acceptance Criteria

* [ ] Helper functions exist and are tested
* [ ] No routes or side effects added
* [ ] Rules are explicit and documented

## Dependencies

* Blocked by: PF-056
* Blocks: future attach endpoints

## Technical Notes

* Likely lives in `internal/media`
* **ASSUMPTION:** Enforcement will be opt-in by callers initially

## Out of Scope

* API endpoints
* Auto-attachment logic

---

## Title [PF-058]: Orphaned media GC scheduler (future)

## Type

Task

## Description

Implement a **scheduler job** that cleans up orphaned media (no attachments) after a safe TTL. Prevents storage bloat and compliance risk.

## Scope

* Daily scheduled job
* Identify media with:

  * zero attachments
  * older than configured threshold
* Delete DB row + GCS object (idempotent)

## Acceptance Criteria

* [ ] Scheduler runs idempotently
* [ ] Only unreferenced media is deleted
* [ ] Failures are logged and retry-safe

## Dependencies

* Blocked by: PF-054
* Blocks: long-term storage hygiene

## Technical Notes

* Worker scheduler
* Tables: `media`, `media_attachments`
* **ASSUMPTION:** TTL default = 30 days

## Out of Scope

* Manual/admin-triggered GC

---

## Title [PF-059]: Media audit logging (future)

## Type

Task

## Description

Add **audit log entries** for sensitive media lifecycle events to support compliance and debugging.

## Scope

* Audit events:

  * upload
  * delete
  * processing start/fail/complete
* Append-only audit logs

## Acceptance Criteria

* [ ] Audit rows written for defined events
* [ ] No sensitive data logged
* [ ] Actor + store context preserved

## Dependencies

* Blocked by: PF-054
* Blocks: compliance review tooling

## Technical Notes

* Table: `audit_logs`
* **ASSUMPTION:** Media OCR text is never logged

## Out of Scope

* Admin UI
* Audit export

---

[NEXT ⭐️]
## Title [PF-060]: Media processing pipeline interface (media_kind → processor) 

## Type

Task

## Description

Define a **pluggable media processing pipeline** that maps `media.kind` to one or more processors. No processors are enabled by default.

## Scope

* Processor interface
* Registry by `media_kind`
* Feature-flagged execution

## Acceptance Criteria

* [ ] Interface defined and documented
* [ ] No processing runs without flag enabled
* [ ] Worker boot does not change behavior

## Dependencies

* Blocked by: none
* Blocks: PF-061, PF-062

## Technical Notes

* Worker binary
* **ASSUMPTION:** Processing is async + idempotent

## Out of Scope

* Actual processing logic

---

[NEXT ⭐️]
## Title [PF-061]: MIME-based image/video compression processor (disabled)

## Type

Task

## Description

Implement an **image/video compression processor** that can downscale or recompress large uploads. Processor is **disabled by default**.

## Scope

* Validate MIME vs `media.kind`
* Compression stub or real implementation
* Update `media.is_compressed`

## Acceptance Criteria

* [ ] Processor registers cleanly
* [ ] Disabled unless feature flag enabled
* [ ] Failure does not block media usability

## Dependencies

* Blocked by: PF-060
* Blocks: performance optimizations

## Technical Notes

* Worker-side only
* **ASSUMPTION:** Exact compression settings TBD

## Out of Scope

* Automatic retroactive compression

---

[NEXT ⭐️]
## Title [PF-062]: OCR processor for PDFs / COAs (disabled)

## Type

Task

## Description

Add an **OCR processor** for PDF-based media (licenses, COAs). Extracted text is stored but never logged.

## Scope

* OCR hook for `media.kind = pdf | coa`
* Store extracted text in `media.ocr`
* Feature-flagged execution

## Acceptance Criteria

* [ ] OCR processor is registered
* [ ] Disabled by default
* [ ] OCR failures do not block media usage

## Dependencies

* Blocked by: PF-060
* Blocks: automated compliance extraction

## Technical Notes

* Worker-side only
* **ASSUMPTION:** OCR provider TBD (Document AI or similar)

## Out of Scope

* Validation of extracted data
* Auto-approval logic

---
