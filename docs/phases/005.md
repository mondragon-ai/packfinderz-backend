

# [PF-060] — OutboxEvent Model, Enums, Envelope + Migration

## Type

Feature

## Description

Introduce the canonical **append-only OutboxEvent model** with locked schema, **authoritative enum definitions**, and a **stable payload envelope** to support versioned, extensible domain events written within DB transactions.

This ticket establishes the foundation all other outbox work depends on.

## Scope

* Create `outbox_events` table via Goose migration
* Define GORM model in `/pkg/db/model`
* Define canonical `event_type` and `aggregate_type` enums
* Define stable JSON payload envelope structs
* Enforce append-only semantics at application level

## Acceptance Criteria

* [ ] `outbox_events` table exists with locked schema and indexes
* [ ] GORM model matches schema exactly
* [ ] Enums are centrally defined and reused (no duplication)
* [ ] Payload envelope structs exist and are documented
* [ ] Only allowed fields are mutable (`published_at`, `attempt_count`, `last_error`)

## Dependencies

* Blocked by: none
* Blocks: PF-061, PF-062

## Technical Notes

**Schema (LOCKED)**

```sql
id              UUID PK
event_type      event_type_enum NOT NULL
aggregate_type  aggregate_type_enum NOT NULL
aggregate_id    UUID NOT NULL
payload_json    JSONB NOT NULL
created_at      TIMESTAMPTZ NOT NULL DEFAULT now()
published_at    TIMESTAMPTZ NULL
attempt_count   INT NOT NULL DEFAULT 0
last_error      TEXT NULL
```

**aggregate_type enums**

* `vendor_order`
* `checkout_group`
* `license`
* `store`
* `media`
* `ledger_event`
* `notification`
* `ad` (business-level lifecycle only)

**event_type enums**
*Core*

* `order_created`
* `order_state_changed`
* `line_item_state_changed`
* `license_status_changed`
* `media_uploaded`
* `payment_settled`
* `cash_collected`
* `vendor_payout_recorded`
* `notification_requested`

*Optional*

* `order_expired`
* `order_canceled`
* `reservation_released`

*Ads (non-telemetry)*

* `ad_created`
* `ad_updated`
* `ad_paused`
* `ad_activated`
* `ad_expired`
* `ad_daily_rollup_ready`

**Indexes**

* `(published_at)`
* `(event_type)`
* `(aggregate_type, aggregate_id)`

**Payload Envelope (LOCKED)**

```go
type OutboxPayloadEnvelope struct {
  Version    int             `json:"version"`
  EventID    string          `json:"eventId"`
  OccurredAt time.Time       `json:"occurredAt"`
  Actor      *ActorRef       `json:"actor,omitempty"`
  Data       json.RawMessage `json:"data"`
}
```

* **ASSUMPTION:** Enums are implemented as Postgres enums (not free-text).
* Add other envelopes that may be relevant, we will add more per ticket later if needed. 

## Out of Scope

* Publishing
* Consumers
* Retention / cleanup
* Telemetry events (clicks, impressions)

---

# PF-061 — Outbox Publisher Worker (`cmd/outbox-publisher`)

## Title

Build idempotent Outbox publisher worker

## Type

Task

## Description

Create a dedicated worker binary that reliably publishes unpublished Outbox events to Pub/Sub and marks delivery state in Postgres.

## Scope

* New binary: `cmd/outbox-publisher`
* Poll unpublished outbox rows
* Publish events to Pub/Sub
* Update publish status in DB

## Acceptance Criteria

* [ ] Worker fetches unpublished rows in batches
* [ ] Successful publish sets `published_at`
* [ ] Failures increment `attempt_count` and set `last_error`
* [ ] Worker is safe to restart at any time

## Dependencies

* Blocked by: PF-060
* Blocks: PF-062

## Technical Notes

* Topic selection based on `event_type` (case switch for payload & building envelope message to pubsub)
* No domain logic
* No event mutation 
* Exponential backoff required
* Health endpoint required (add to ready)

**Infra updates**

For the worker binary: 

* Makefile
* Dockerfile
* Heroku Procfile

## Out of Scope

* DLQ
* Retention cleanup
* Consumers
* Schema changes

---

# [PF-062] — Outbox DTOs, Registry, Repo, Service + Wiring

## Type

Feature

## Description

Provide a reusable, transaction-aware Outbox API for all domains, including **DTOs, repository, service, and payload decoding registry**.

## Scope

* Canonical DTOs and enums
* Payload decoder registry `(event_type, version)`
* Transaction-aware repository
* Domain-facing Outbox service
* Global wiring for API + workers

## Acceptance Criteria

* [ ] Domains emit events only via Outbox service
* [ ] Repository accepts DB transaction
* [ ] Payload decoding uses envelope + registry
* [ ] No Pub/Sub usage in domain code

## Dependencies

* Blocked by: PF-060
* Blocks: all domain integrations, PF-061

## Technical Notes

**Repository (LOCKED)**

```go
Insert(tx *gorm.DB, event OutboxEvent) error
FetchUnpublished(limit int) ([]OutboxEvent, error)
MarkPublished(id uuid.UUID) error
MarkFailed(id uuid.UUID, err error) error
```

**Service (LOCKED)**

```go
Emit(tx *gorm.DB, event DomainEvent) error
```

**Decoder Registry**

* Key: `(event_type, version)`
* Maps to concrete payload decoder + handler
* Payloads are versioned JSON

**Wiring required**

* API layer
* Orders
* Licenses
* Media
* Notifications
* Analytics
* Ads (business-level only)

## Out of Scope

* Direct Pub/Sub publishing from domains
* Worker-to-worker communication
* Telemetry (clicks, impressions)
* Billing logic

