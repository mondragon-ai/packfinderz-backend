## [PF-033] Implement store profile read endpoint (active store)

## Type

Feature

## Description

Implement an authenticated endpoint to fetch the **active store’s full profile** based on `activeStoreId` from JWT. This endpoint returns **non-public internal fields** and is used for store settings.

## Scope

* Fetch store by `activeStoreId`
* Return full store profile.
* Enforce store-scoped authorization

## Acceptance Criteria

* [ ] `GET /api/v1/stores/me` returns store data for `activeStoreId`
* [ ] Request without `activeStoreId` && valid JWT is rejected
* [ ] Buyer and vendor stores are both supported
* [ ] Response omits any fields not allowed to be read (e.g., internal-only flags if any)

## Dependencies

* Blocked by: Auth + JWT with `activeStoreId`
* Blocks: Store settings UI, store update endpoint

## Technical Notes

* Table: `stores`
* Authorization: store-scoped
* **ASSUMPTION:** Address is returned but not editable in MVP

## Out of Scope

* Public vendor directory fields
* Store analytics data

---

## [PF-034] Implement store profile update endpoint (non-address fields)

## Type

Feature

## Description

Implement an endpoint to update **mutable store fields only** for the active store. Address fields are immutable in MVP and must not be modifiable via this endpoint.

## Scope

* Update allowed store fields (e.g., `description`, `phone`, `email`, `social`, `company_name`, `banner_url`, `logo_url` etc)
* Enforce role-based access (owner/manager only)
* Prevent address or geo changes

## Acceptance Criteria

* [ ] `PUT /api/v1/stores/me` updates allowed fields only
* [ ] Attempt to modify address or geo fields is rejected
* [ ] Only authorized roles may update store
* [ ] Updated timestamps reflect changes

## Dependencies

* Blocked by: [PF-033]
* Blocks: Store settings management

## Technical Notes

* Table: `stores`
* Validation required at API layer
* **ASSUMPTION:** Address mutability handled only via admin override later
* We need to create a new goose migrations to add these fields to a store:  `banner_url` (string), `logo_url` (string), `ratings` (map[string]int), `Categories` (string[])

## Out of Scope

* Admin override of store address
* Subscription or KYC status updates

---

## [PF-035] Implement store user list endpoint

## Type

Feature

## Description

Implement an endpoint to list **all users (memberships)** associated with the active store. Used for store user management.

## Scope

* Fetch memberships for `activeStoreId`
* Include user basic profile + role
* Enforce store-scoped access  (`managers` & `owner` roles can access)

## Acceptance Criteria

* [ ] `GET /api/v1/stores/me/users` returns memberships for active store
* [ ] Only authorized roles can access this endpoint (`managers` & `owner`)
* [ ] Each entry includes user id, email, name (first & last name), role, created_at, last_login_at, member_role, membership_status (pulled from store_member row and may join from User table)

## Dependencies

* Blocked by: Store membership model
* Blocks: Invite/remove user flows

## Technical Notes

* Tables: `store_memberships`, `users`
* **ASSUMPTION:** Pagination optional for MVP due to low cardinality

## Out of Scope

* Cross-store user search
* Role modification (future)

---

## [PF-036] Implement invite user endpoint (temporary password)

## Type

Feature

## Description

Implement an endpoint to invite a user to the active store by email and role. If the user does not exist, create them with a **temporary password** and add store membership.

## Scope

* Accept email + role
* Create user if not exists
* Create store membership
* Idempotent behavior

## Acceptance Criteria

* [ ] `POST /api/v1/stores/me/users/invite` creates membership
* [ ] Existing users are reused (no duplicate users)
* [ ] Temporary password is generated (not logged)
* [ ] Duplicate invite returns idempotent success

## Dependencies

* Blocked by: Users + memberships
* Blocks: Team management

## Technical Notes

* Tables: `users`, `store_memberships`
* **ASSUMPTION:** Temp password is communicated out-of-band
* **ASSUMPTION:** Email sending not implemented yet

## Out of Scope

* Email delivery
* Invite acceptance flow

---

## [PF-037] Implement remove store user endpoint

## Type

Feature

## Description

Implement endpoint to remove a user from the active store by deleting the store membership only.

## Scope

* Delete `store_memberships` row
* Prevent removing last owner
* Enforce authorization

## Acceptance Criteria

* [ ] `DELETE /api/v1/stores/me/users/{userId}` removes membership
* [ ] Removing last owner is rejected
* [ ] User account itself is not deleted

## Dependencies

* Blocked by: [PF-035]
* Blocks: Store user management completeness

## Technical Notes

* Table: `store_memberships`
* **ASSUMPTION:** Last-owner constraint enforced at API layer

## Out of Scope

* Deleting users globally
* Role reassignment

---

## [PF-038] Implement license metadata creation endpoint

## Type

Feature

## Description

Create an endpoint to create a **license metadata record** in `pending` state before document upload is finalized.

## Scope

* Create license row with metadata
* Associate license with active store
* Idempotent behavior

## Acceptance Criteria

* [ ] `POST /api/v1/licenses` creates license with `pending` status
* [ ] License belongs to `activeStoreId`
* [ ] Duplicate submission with same idempotency key replays response

## Dependencies

* Blocked by: Stores, auth
* Blocks: License upload + verification

## Technical Notes

* Table: `licenses`
* **ASSUMPTION:** Media attachment added later via finalize endpoint

## Out of Scope

* Document upload
* Verification logic

---

## [PF-039] Implement GCS presigned upload helper + endpoint (licenses)

## Type

Infra

## Description

Implement a reusable **GCS client helper** and an endpoint to generate presigned upload URLs for license documents.

## Scope

* GCS client in `pkg/storage` (or equivalent)
* Presigned URL generation
* Endpoint for license uploads

## Acceptance Criteria

* [ ] GCS helper initializes using service credentials
* [ ] `POST /api/v1/media/presign` returns valid signed URL
* [ ] URL is time-limited and upload-only

## Dependencies

* Blocked by: GCS credentials/config
* Blocks: License document upload

## Technical Notes

* Service: Google Cloud Storage
* **ASSUMPTION:** Same helper reused for all media types later

## Out of Scope

* Media finalization
* Background processing

---

## [PF-040] Implement license finalize endpoint

## Type

Feature

## Description

Implement endpoint to finalize a license upload by attaching uploaded media to the license record and emitting an outbox event.

## Scope

* Attach media to license
* Update license record
* Emit outbox event

## Acceptance Criteria

* [ ] `POST /api/v1/licenses/{id}/finalize` attaches media
* [ ] License remains `pending` after finalize
* [ ] Outbox event is written in same transaction

## Dependencies

* Blocked by: [PF-038], [PF-039], outbox infra
* Blocks: Admin verification, notifications

## Technical Notes

* Tables: `licenses`, `media`, `media_attachments`, `outbox_events`
* **ASSUMPTION:** Worker handles notifications later

## Out of Scope

* Media processing
* Admin actions

---

## [PF-041] Implement list licenses endpoint (active store)

## Type

Feature

## Description

Implement endpoint to list all licenses belonging to the active store.

## Scope

* Fetch licenses by store
* Support basic filtering (status)
* Enforce store-scoped access

## Acceptance Criteria

* [ ] `GET /api/v1/licenses` returns licenses for active store
* [ ] Only authorized roles may access
* [ ] Response includes status and expiration dates

## Dependencies

* Blocked by: [PF-038]
* Blocks: Store compliance UI

## Technical Notes

* Table: `licenses`
* **ASSUMPTION:** Pagination optional for MVP

## Out of Scope

* Cross-store license views

---

## [PF-042] Implement delete license endpoint

## Type

Feature

## Description

Implement endpoint to delete a license belonging to the active store and detach associated media.

## Scope

* Delete license row
* Remove media attachment
* Enforce authorization

## Acceptance Criteria

* [ ] `DELETE /api/v1/licenses/{licenseId}` deletes license
* [ ] Media is detached (not necessarily deleted)
* [ ] Unauthorized access is rejected

## Dependencies

* Blocked by: [PF-041]
* Blocks: License lifecycle completeness

## Technical Notes

* Tables: `licenses`, `media_attachments`
* **ASSUMPTION:** Media GC handled separately

## Out of Scope

* Hard delete of media objects

---

## [PF-043] Implement admin license verify/reject endpoint

## Type

Feature

## Description

Implement admin-only endpoint to verify or reject a license and update its status.

## Scope

* Admin authorization
* Update license status
* Record audit log

## Acceptance Criteria

* [ ] `POST /api/v1/admin/licenses/{licenseId}/verify` updates status
* [ ] Only admin users can access
* [ ] Audit log entry is created

## Dependencies

* Blocked by: Admin auth, audit logging
* Blocks: Store KYC mirroring

## Technical Notes

* Tables: `licenses`, `audit_logs`
* **ASSUMPTION:** Admin UI implemented later

## Out of Scope

* Automation of verification

---

## [PF-044] Mirror license status changes to store KYC status

## Type

Task

## Description

Ensure store `kyc_status` is updated based on license verification outcomes.

## Scope

* Update store on license verify/reject/expire
* Handle multiple licenses per store

## Acceptance Criteria

* [ ] Verified license sets store KYC to `verified`
* [ ] All licenses rejected/expired sets store accordingly
* [ ] Changes are transactional

## Dependencies

* Blocked by: [PF-043]
* Blocks: Buyer/vendor gating

## Technical Notes

* Tables: `licenses`, `stores`
* **ASSUMPTION:** “At least one verified license = store verified”

## Out of Scope

* Manual admin overrides

---

## [PF-045] Add license expiry scheduler + compliance notifications

## Type

Task

## Description

Implement a scheduler to handle license expiry checks and generate in-app compliance notifications.

## Scope

* Daily job:

  * notify licenses expiring in 14 days
  * mark expired licenses
* Emit outbox events
* Create notifications

## Acceptance Criteria

* [ ] Scheduler runs daily
* [ ] Expiring licenses trigger notifications
* [ ] Expired licenses update status and store KYC
* [ ] All actions are idempotent

## Dependencies

* Blocked by: Worker infrastructure, notifications
* Blocks: Compliance enforcement

## Technical Notes

* Tables: `licenses`, `notifications`, `outbox_events`
* **ASSUMPTION:** Email notifications added later

## Out of Scope

* SMS/email delivery
* Manual scheduling UI
