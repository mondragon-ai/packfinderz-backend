# Title [PF-195]: Add field to agent registration DTO

## Type

Feature

## Description

Extend the agent registration contract to include a `first_names` and `last_name` field, enabling capture of the agent’s display or legal names at registration time. This closes a contract gap and aligns agent onboarding with downstream usage.

## Scope

* Add `first_names` and `last_name` field to agent registration request DTO
* Validate `first_names` and `last_name` (non-empty string or structured type as per existing DTO conventions)
* Persist `first_names` and `last_name` to the agent profile model
* Update any relevant serializers/mappers

**Explicitly NOT included**

* UI changes
* Backfilling existing agent records
* Renaming or refactoring other user fields

## Acceptance Criteria

* [ ] Agent registration accepts `first_names` and `last_name` and persists it
* [ ] Missing or invalid `first_names` and `last_name` fails validation with a clear error

## Dependencies

* Blocked by: None
* Blocks: None

## Technical Notes

* Files: agent registration DTO, controller, service, model
* Validation should mirror existing DTO validation patterns

## Out of Scope

* Localization or formatting rules for names

---

# Title [PF-196]: Add auth middleware tests for token and session edge cases

## Type

Task

## Description

Add comprehensive tests for authentication middleware to lock behavior around missing/expired tokens, revoked sessions, and missing `activeStoreId`. This hardens auth contracts and prevents regressions.

## Scope

* Tests for:

  * Missing access token
  * Expired access token
  * Revoked session
  * Missing `activeStoreId` claim
* Assert correct HTTP status codes and error payloads

**Explicitly NOT included**

* Changes to middleware logic
* Token issuance changes

## Acceptance Criteria

* [ ] Each edge case has a dedicated test
* [ ] Tests assert exact status codes and messages
* [ ] Tests fail if middleware behavior changes unintentionally

## Dependencies

* Blocked by: Existing auth middleware
* Blocks: None

## Technical Notes

* Test location: auth middleware test suite
* Use table-driven tests where appropriate
* **ASSUMPTION:** Revoked session state is detectable via existing Redis/session store

## Out of Scope

* Performance testing
* Fuzz testing

---

# Title [PF-197]: Add RBAC guard tests for admin and agent routes

## Type

Task

## Description

Add RBAC guard tests to ensure only authorized roles can access `/api/admin/*` and `/api/v1/agent/*` routes. This locks role-based access control contracts.

## Scope

* Tests for admin-only routes under `/api/admin/*`
* Tests for agent-only routes under `/api/v1/agent/*`
* Verify forbidden access for non-authorized roles

**Explicitly NOT included**

* RBAC logic changes
* New roles or permissions

## Acceptance Criteria

* [ ] Unauthorized roles receive 403 on admin routes
* [ ] Unauthorized roles receive 403 on agent routes
* [ ] Authorized roles succeed without regression

## Dependencies

* Blocked by: RBAC middleware/guards
* Blocks: None

## Technical Notes

* Use role-scoped test tokens
* Keep tests isolated per route group
* **ASSUMPTION:** Role claims are already embedded in JWTs

## Out of Scope

* Fine-grained permission matrices
* Audit logging validation

---

# Title [PF-198]: Remove `store_ids` from User model and helpers

## Type

Chore

## Description

Remove deprecated `store_ids` fields from the User model to enforce the canonical user–store relationship via membership tables. This reduces ambiguity and aligns with multi-store ownership.

## Scope

* Goose migration to drop `store_ids` columns from users
* Update User model to remove `store_ids` fields
* Update helpers/services referencing removed fields

**Explicitly NOT included**

* Data backfills or migrations to new relationships
* API contract changes beyond removal of deprecated fields

## Acceptance Criteria

* [ ] Database migration removes `store_ids` fields
* [ ] Application compiles without references to removed fields
* [ ] Existing user–store access works via membership logic

## Dependencies

* Blocked by: None
* Blocks: PF-205

## Technical Notes

* Migration must be reversible if possible
* Search codebase for all references before removal
* **ASSUMPTION:** User–store relationships already exist elsewhere (e.g., memberships table)

## Out of Scope

* Changing membership semantics
* Authorization behavior changes

---

# [INCOMPLETE ❌] Title [PF-204]: Remove tokens from auth response bodies and return via headers only

## Type

Feature

## Description

Harden auth contracts by removing access and refresh tokens from login/register response bodies. Tokens must be returned exclusively via HTTP headers to prevent accidental leakage.

## Scope

* Remove tokens from JSON bodies of login/register responses
* Set access and refresh tokens in response headers
* Update tests to assert header-based token delivery

**Explicitly NOT included**

* Token format changes
* Cookie-based auth

## Acceptance Criteria

* [ ] Login/register responses contain no tokens in body
* [ ] Tokens are present in documented response headers
* [ ] Existing clients can read tokens from headers

## Dependencies

* Blocked by: None
* Blocks: None

## Technical Notes

* Headers should follow existing naming conventions
* Update API contract tests accordingly
* **ASSUMPTION:** Clients are able to consume headers without breaking changes

## Out of Scope

* Deprecation warnings to clients
* Header encryption

---

# [INCOMPLETE ❌] Title [PF-205]: Allow register flow to create a store for an existing user

## Type

Feature

## Description

Modify the registration flow to support creating a new store for an already-existing user account. Users may own zero or more stores without duplicating user records.

## Scope

* Detect existing user by unique identifier (e.g., email)
* Allow creation of a new store linked to the existing user
* Ensure ownership/membership records are created correctly

**Explicitly NOT included**

* Merging duplicate user accounts
* UI changes for multi-store management

## Acceptance Criteria

* [ ] Existing user can register and create an additional store
* [ ] No duplicate user records are created
* [ ] User–store ownership is correctly established

## Dependencies

* Blocked by: PF-203
* Blocks: None

## Technical Notes

* Registration service must branch on user existence
* Use transaction to ensure user and store linkage consistency
* **ASSUMPTION:** Email remains the unique user identifier

## Out of Scope

* Store invitation flows
* Store deletion or transfer of ownership
