
## **[PF-084] Add Missing Order Indexes for Read + Action Queues**

## Type

Task

## Description

Add missing Postgres indexes required to efficiently support buyer/vendor order lists, “needs action” vendor queues, and agent assignment lookups as required by Phase 7 read APIs and schedulers.

## Scope

* Add composite and directional indexes for order listing and action queues
* Validate existing indexes and add only what is missing

## Acceptance Criteria

* [ ] Buyer order list queries use `(buyer_store_id, created_at DESC)`
* [ ] Vendor order list queries use `(vendor_store_id, created_at DESC)`
* [ ] “Needs action” vendor queue uses `(vendor_store_id, status, created_at DESC)`
* [ ] Agent assignment lookups are indexed efficiently
* [ ] All new indexes are created via Goose migration

## Dependencies

* Blocked by: None
* Blocks: PF-XXX, PF-XXX, PF-XXX, PF-XXX

## Technical Notes

* Tables: `vendor_orders`, `order_assignments`
* Migration-only change
* **ASSUMPTION:** Some indexes may already exist; add only missing ones

## Out of Scope

* Query rewrites
* Materialized views

---

## **[PF-085] Repository: Buyer Orders List (Paginated + Filtered)**

## Type

Feature

## Description

Implement repository method to fetch buyer-perspective orders with cursor pagination and filters, returning summary-level order data for dashboards.

## Scope

* Buyer-perspective orders only (`buyer_store_id = activeStoreId`)
* Filters: status, date range
* Cursor-based pagination (see the reusable doc to use the global pagination helpers)
* Add goose migration if needed to create an `order_number` field that incrimentally increases each new row

## Acceptance Criteria

* [ ] Returns orders scoped to buyer store only
* [ ] Supports `limit + cursor`
* [ ] Supports These Query params for filtering: `fulfillment_status`, `order_status`, `payment_status`,  
* [ ] Supports searching `q=...` to search fo the buyer | vendor name
* [ ] Includes total value + discounts, total items, payment status, fulfillment status, shipping status, vendor summary, date created & order number
* [ ] Results ordered by `created_at DESC`

## Dependencies

* Blocked by: PF-XXX
* Blocks: PF-XXX

## Technical Notes

* Repo: `internal/orders/repository`
* Tables: `vendor_orders`, `stores`
* **ASSUMPTION:** Vendor logo is optional and nullable

## Out of Scope

* Order detail loading
* Authorization checks (handled at service/controller layer)

---

## **[PF-086] Repository: Vendor Orders List (Paginated + Filtered)**

## Type

Feature

## Description

Implement repository method to fetch vendor-perspective orders with cursor pagination and filters for vendor dashboards.

## Scope

* Vendor-perspective orders only (`vendor_store_id = activeStoreId`)
* Filters: statuses, date range,
* Cursor-based pagination (see the reusable doc to use the global pagination helpers)

## Acceptance Criteria

* [ ] Returns orders scoped to vendor store only
* [ ] Supports `limit + cursor`
* [ ] Supports These Query params for filtering: `fulfillment_status`, `order_status`, `payment_status`,  
* [ ] Supports searching `q=...` to search fo the buyer | vendor name
* [ ] Includes total value + discounts, total items, payment status, fulfillment status, shipping status, buyer summary info, date created & order number
* [ ] Results ordered by `created_at DESC`
* [ ] Supports filtering by actionable states
* [ ] Cursor pagination works deterministically

## Dependencies

* Blocked by: PF-083
* Blocks: PF-XXX

## Technical Notes

* Repo: `internal/orders/repository`
* Tables: `vendor_orders`, `stores`
* **ASSUMPTION:** Buyer logo not required for MVP

## Out of Scope

* Order detail loading

---

## **[PF-087] Repository: Order Detail with Preloads**

## Type

Feature

## Description

Implement repository method to fetch a single order with all required preloaded relations for order detail views.

## Scope

* Load order, line items, payment intent, buyer + vendor store info, agent assignment

## Acceptance Criteria

* [ ] Preloads line items and payment intent
* [ ] Includes buyer + vendor store summaries
* [ ] Includes active agent assignment if present || null
* [ ] Enforces store ownership at service layer

## Dependencies

* Blocked by: PF-086/5
* Blocks: PF-XXX, PF-XXX

## Technical Notes

* Repo: `internal/orders/repository`
* Tables: `vendor_orders`, `order_line_items`, `payment_intents`, `order_assignments`
* **ASSUMPTION:** One active assignment max
* `internal/orders.Repository.FindOrderDetail` now preloads line items, payment intent, buyer/vendor store metadata, and the single `active` assignment so controllers can render detail views without extra joins.

## Out of Scope

* State transitions

---

## **[PF-088] Controllers: Order List + Order Detail APIs**

## Type

Feature

## Description

Expose buyer/vendor order list and order detail APIs using perspective-based authorization.

## Scope

* `GET /api/v1/orders`
* `GET /api/v1/orders/{orderId}`

## Acceptance Criteria

* [ ] Buyer sees only buyer-perspective orders
* [ ] Vendor sees only vendor-perspective orders
* [ ] Unauthorized access returns 403
* [ ] Pagination and filters wired correctly

## Dependencies

* Blocked by: PF-XXX, PF-XXX, PF-XXX
* Blocks: PF-XXX

## Technical Notes

* Controllers under `api/controllers/orders`
* Authorization via `activeStoreId` perspective rules

## Out of Scope

* Order mutations

---

## **[PF-089] Vendor Order-Level Decision Service**

## Type

Feature

## Description

Allow vendors to accept or reject an order at the order level with state validation.

## Scope

* `POST /api/v1/vendor/orders/{orderId}/decision`
* Order-level accept/reject only

## Acceptance Criteria

* [ ] Validates current order state
* [ ] Transitions order to accepted or rejected
* [ ] Idempotent via Idempotency-Key
* [ ] Emits `order_decided` outbox event


## Technical Notes

* Service: `internal/orders/service`
* Outbox event: `order_decided`
* **ASSUMPTION:** Line items remain pending until line-level decision

## Out of Scope

* Line-item decisions
* Inventory release

---

## **[PF-090] Vendor Line-Item Decision + Balance Recompute**

## Type

Feature

## Description

Allow vendors to fulfull/reject individual line items, recompute order totals, release inventory, and update fulfillment state.

## Scope

* `POST /api/v1/vendor/orders/{orderId}/line-items/decision`

## Acceptance Criteria

* [ ] Fulfill/reject per line item
* [ ] Recompute `balance_due_cents` -> initiate refund if charged (future ach impimintation)
* [ ] Release inventory for rejected items
* [ ] Update order status correctly -> once all pending items are handled move fulfillment (partial|fulfilled) and order status (transit|hold_for_pickup)
* [ ] Emit `order_fulfilled` outbox once all pending items are handled 

## Dependencies

* Blocks: PF-091

## Technical Notes

* Inventory release must be idempotent
* **ASSUMPTION:** Refund logic is stubbed until ACH

## Out of Scope

* Actual refund execution

---

## **[PF-091] Fulfillment Transition + Dispatch Readiness**

## Type

Feature

## Description

Transition orders to fulfillment-complete state and mark them ready for agent dispatch.

## Scope

* Detect when all line items resolved
* Transition order to `hold`
* Emit dispatch-ready event

## Acceptance Criteria

* [ ] Order transitions to `fulfilled` or `partially_fulfilled`
* [ ] Order status becomes `hold`
* [ ] Emits `order_ready_for_dispatch` outbox event
* [ ] Idempotent behavior ensured

## Dependencies

* Blocked by: PF-XXX
* Blocks: PF-XXX

## Technical Notes

* Service: `internal/orders/service`
* Outbox: `order_ready_for_dispatch`

## Out of Scope

* Agent assignment

---

## **[PF-XXX] Buyer Order Cancel + Nudge + Retry Services**

## Type

Feature

## Description

Implement buyer-side order actions: cancel (pre-transit), nudge vendor, and retry expired orders.

## Scope

* `POST /api/v1/orders/{orderId}/cancel`
* `POST /api/v1/orders/{orderId}/nudge`
* `POST /api/v1/orders/{orderId}/retry`

## Acceptance Criteria

* [ ] Cancel only allowed pre-transit
* [ ] Inventory released on cancel
* [ ] Nudge emits notification event
* [ ] Retry creates new checkout attempt for that single order only
* [ ] Emits `order_canceled` / `order_retried` events

## Dependencies

* Blocked by: PF-XXX
* Blocks: PF-XXX

## Technical Notes

* Retry must not re-run entire checkout group
* **ASSUMPTION:** Retry reuses order snapshot

## Out of Scope

* Multi-vendor retries

---

## **[PF-XXX] Reservation TTL Scheduler (Expire + Nudge)**

## Type

Task

## Description

Implement scheduler to enforce reservation TTL rules: initial TTL, nudge, extension, and expiration with inventory release.

## Scope

* Detect orders past TTL
* Nudge once
* Expire after second window
* Release inventory

## Acceptance Criteria

* [ ] Orders expire after 10 days total
* [ ] Inventory released idempotently
* [ ] `order_expired` outbox event emitted
* [ ] Scheduler safe to rerun

## Dependencies

* Blocked by: PF-XXX
* Blocks: None

## Technical Notes

* Scheduler: `internal/schedulers/orders`
* Outbox event: `order_expired`

## Out of Scope

* Buyer notifications UX
* ACH refund logic
