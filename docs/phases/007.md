## Title [PF-074]: Implement CartRecord and CartItem Data Models

## Type

Feature

## Description

Introduce server-side cart persistence to support checkout staging. The `CartRecord` and `CartItem` models represent a snapshot of the buyerâ€™s cart at checkout confirmation time and act as the authoritative input for checkout execution.

## Scope

* Define `cart_records` and `cart_items` tables per Data Design doc
* Implement Go models + repositories
* Enforce buyer-store ownership

## Acceptance Criteria

* [ ] `cart_records` table exists with buyer_store_id, totals, status, timestamps
* [ ] `cart_items` table exists with product/vendor snapshot fields
* [ ] Foreign keys and indexes match the Data Design specification
* [ ] Models are accessible via repository layer

## Dependencies

* Blocked by: Goose migrations framework in place
* Blocks: Cart upsert endpoint, checkout submission

## Technical Notes

* Tables: `cart_records`, `cart_items`
* Status enum: `active | converted` (**ASSUMPTION**: string enum)
* Cart is buyer-scoped (`buyer_store_id`)
* No pricing recomputation at this layer

## Out of Scope

* Client-side cart logic
* Discounts beyond snapshot persistence

---

## Title [PF-075]: Implement Cart Upsert Endpoint (`PUT /api/v1/cart`)

## Type

Feature

## Description

Provide an idempotent endpoint to create or update a CartRecord and associated CartItems during checkout confirmation. This freezes pricing and MOQ snapshots prior to checkout execution.

## Scope

* Accept cart payload from client
* Upsert CartRecord for active buyer store
* Replace CartItems atomically

## Acceptance Criteria

* [ ] Endpoint requires `Idempotency-Key`
* [ ] Existing active cart is replaced, not duplicated
* [ ] Buyer (valid license) & Vendor (valid license + active sub) are validated server-side + both are in the same state. 
* [ ] Cart totals are validated server-side
* [ ] Discounts, MOQ, availabilty and store discounts are validated server-side
* [ ] Returns CartRecord summary

## Dependencies

* Blocked by: PF-074
* Blocks: Checkout submission endpoint

## Technical Notes

* Route: `PUT /api/v1/cart`
* Use transaction: delete + insert cart_items
* Validate `activeStoreId` is buyer store
* TTL for idempotency: 24h

## Out of Scope

* Inventory reservation
* Checkout execution

---

## Title [PF-076]: Implement Cart Fetch Endpoint (`GET /api/v1/cart`)

## Type

Feature

## Description

Allow buyers to retrieve the currently active CartRecord for their store to support refresh, retry, or UI recovery.

## Scope

* Fetch active cart for buyer store
* Include cart items with snapshots

## Acceptance Criteria

* [ ] Returns 200 with cart if exists
* [ ] Returns 404 if no active cart
* [ ] Enforces buyer-store access

## Dependencies

* Blocked by: PF-601
* Blocks: Frontend checkout flow

## Technical Notes

* Route: `GET /api/v1/cart`
* Join `cart_items`
* No mutation allowed

## Out of Scope

* Editing cart contents
* Checkout logic

---

## Title [PF-077]: Implement Checkout Submission Endpoint (`POST /api/v1/checkout`)

## Type

Feature

## Description

Convert a CartRecord into a CheckoutGroupID and per-vendor VendorOrders with atomic inventory reservation and partial success semantics (go routine necessary for scalablility or inline synchronous is okay?).

## Scope

* Validate cart contents
* Create CheckoutGroupID
* Create VendorOrders + LineItems
* Create PaymentIntents
* Handle partial success

## Acceptance Criteria

* [ ] Endpoint requires `Idempotency-Key`
* [ ] CartRecord marked `converted`
* [ ] CheckoutGroupID created exactly once -> added to cart
* [ ] VendorOrders created per vendor
* [ ] Returns created order summaries

## Dependencies

* Blocked by: PF-601, PF-602
* Blocks: Order lifecycle workflows

## Technical Notes

* Route: `POST /api/v1/checkout`
* One DB transaction per checkout attempt
* Idempotency TTL: 7 days
* MOQ violations return 422 with details

## Out of Scope

* Payment collection
* Vendor acceptance flows

---

## Title [PF-078]: Create CheckoutGroupID Entity During Checkout

## Type

Task

## Description

Persist a CheckoutGroupID record to act as a durable receipt linking all VendorOrders created from a single checkout attempt.

## Scope

* Create `checkout_groups` row
* Link to buyer store and cart

## Acceptance Criteria

* [ ] CheckoutGroupID created exactly once per checkout
* [ ] All VendorOrders reference the same checkout_group_id
* [ ] CheckoutGroupID persists after cart deletion

## Dependencies

* Blocked by: PF-604
* Blocks: Analytics, retries, attribution

## Technical Notes

* Table: `checkout_groups`
* FK: buyer_store_id
* Optional FK: cart_id

## Out of Scope

* Checkout retries
* Analytics ingestion

---

## Title [PF-079]: Create VendorOrders Per Vendor During Checkout

## Type

Feature

## Description

Split a checkout into one VendorOrder per vendor, enforcing buyer/vendor perspective rules and per-order totals.

## Scope

* Group cart items by vendor
* Create VendorOrder rows
* Create OrderLineItems

## Acceptance Criteria

* [ ] One VendorOrder per vendor per checkout
* [ ] Line items snapshot product data
* [ ] Totals computed per VendorOrder
* [ ] Buyer/vendor store IDs enforced

## Dependencies

* Blocked by: PF-604
* Blocks: Vendor acceptance workflows

## Technical Notes

* Table: `vendor_orders`, `order_line_items`
* Enforce `buyer_store_id != vendor_store_id`
* Initial status: `created_pending`

## Out of Scope

* Vendor decision logic
* Fulfillment

---

## Title [PF-080]: Implement Atomic Inventory Reservation Logic

## Type

Feature

## Description

Prevent overselling by atomically reserving inventory per line item during checkout using optimistic locking.

## Scope

* Reserve inventory per product
* Handle insufficient inventory gracefully

## Acceptance Criteria

* [ ] Reservation uses conditional UPDATE
* [ ] available_qty never goes negative
* [ ] reserved_qty increases atomically
* [ ] Failed reservations do not affect others

## Dependencies

* Blocked by: PF-604
* Blocks: Correct checkout behavior

## Technical Notes

* SQL pattern from MASTER CONTEXT
* Executed inside checkout transaction
* Retry-safe logic

## Out of Scope

* Inventory release (handled later)
* Background reconciliation

---

## Title [PF-081]: Enforce Partial Checkout Semantics

## Type

Task

## Description

Allow checkout to succeed even if some vendors or line items fail reservation, returning clear feedback to the buyer.

## Scope

* Partial vendor success
* Partial line-item rejection

## Acceptance Criteria

* [ ] Checkout proceeds with successful vendors
* [ ] Failed vendors reported explicitly
* [ ] Rejected line items marked correctly
* [ ] Buyer sees adjusted totals

## Dependencies

* Blocked by: PF-607
* Blocks: Buyer UX correctness

## Technical Notes

* Partial success allowed across vendors
* Line item failures do not abort transaction
* Balance_due updated post-rejection

## Out of Scope

* Automatic retries
* Buyer confirmation dialogs

---

## Title [PF-082]: Enforce Checkout Idempotency

## Type

Task

## Description

Guarantee that repeated checkout submissions do not create duplicate CheckoutGroupIDs or VendorOrders.

## Scope

* Idempotency middleware enforcement
* Response replay on retries

## Acceptance Criteria

* [ ] Same Idempotency-Key returns same result
* [ ] Duplicate submissions do not double-reserve inventory
* [ ] Mismatched body returns 409

## Dependencies

* Blocked by: PF-604
* Blocks: Production readiness

## Technical Notes

* Redis-backed idempotency
* Scope: `(userId, storeId, method, path, key)`
* TTL: 7 days

## Out of Scope

* Manual replay tooling
* Admin overrides

---

## Title [PF-083]: Emit `order_created` Outbox Event After Checkout

## Type

Task

## Description

Emit an `order_created` domain event via the outbox pattern after successful checkout to drive notifications and analytics.

## Scope

* Write OutboxEvent rows
* Include CheckoutGroupID and VendorOrder context

## Acceptance Criteria

* [ ] OutboxEvent written in same DB transaction
* [ ] Event type = `order_created`
* [ ] Payload includes IDs for downstream consumers
* [ ] Event published asynchronously

## Dependencies

* Blocked by: PF-604
* Blocks: Notifications, analytics

## Technical Notes

* Table: `outbox_events`
* Publisher: `cmd/outbox-publisher`
* Consumers must be idempotent

## Out of Scope

* Consumer implementations
* BigQuery schema changes
