## Title [PF-074]: Implement CartRecord and CartItem Data Models

## Type

Feature

## Description

Introduce server-side cart persistence to support checkout staging. The `CartRecord` and `CartItem` models represent a snapshot of the buyer’s cart at checkout confirmation time and act as the authoritative input for checkout execution.

## Scope

* Define `cart_records` and `cart_items` tables per Data Design doc
* Implement Go models + repositories
* Enforce buyer-store ownership

## Acceptance Criteria

* [ ] `cart_records` table exists with buyer_store_id, totals, status, timestamps
* [ ] `cart_items` table exists with product/vendor snapshot fields
* [ ] Foreign keys and indexes match the Data Design specification
* [ ] Models are accessible via repository layer

## Dependencies

* Blocked by: Goose migrations framework in place
* Blocks: Cart upsert endpoint, checkout submission

## Technical Notes

* Tables: `cart_records`, `cart_items`
* Status enum: `active | converted` (**ASSUMPTION**: string enum)
* Cart is buyer-scoped (`buyer_store_id`)
* No pricing recomputation at this layer

## Out of Scope

* Client-side cart logic
* Discounts beyond snapshot persistence

---

## Title [PF-075]: Implement Cart Upsert Endpoint (`PUT /api/v1/cart`)

## Type

Feature

## Description

Provide an idempotent endpoint to create or update a CartRecord and associated CartItems during checkout confirmation. This freezes pricing and MOQ snapshots prior to checkout execution.

## Scope

* Accept cart payload from client
* Upsert CartRecord for active buyer store
* Replace CartItems atomically

## Acceptance Criteria

* [ ] Endpoint requires `Idempotency-Key`
* [ ] Existing active cart is replaced, not duplicated
* [ ] Buyer (valid license) & Vendor (valid license + active sub) are validated server-side + both are in the same state. 
* [ ] Cart totals are validated server-side
* [ ] Discounts, MOQ, availabilty and store discounts are validated server-side
* [ ] Returns CartRecord summary

## Dependencies

* Blocked by: PF-074
* Blocks: Checkout submission endpoint

## Technical Notes

* Route: `PUT /api/v1/cart`
* Use transaction: delete + insert cart_items
* Validate `activeStoreId` is buyer store
* TTL for idempotency: 24h

## Out of Scope

* Inventory reservation
* Checkout execution

---

## Title [PF-076]: Implement Cart Fetch Endpoint (`GET /api/v1/cart`)

## Type

Feature

## Description

Allow buyers to retrieve the currently active CartRecord for their store to support refresh, retry, or UI recovery.

## Scope

* Fetch active cart for buyer store
* Include cart items with snapshots

## Acceptance Criteria

* [ ] Returns 200 with cart if exists
* [ ] Returns 404 if no active cart
* [ ] Enforces buyer-store access

## Dependencies

* Blocked by: PF-601
* Blocks: Frontend checkout flow

## Technical Notes

* Route: `GET /api/v1/cart`
* Join `cart_items`
* No mutation allowed

## Out of Scope

* Editing cart contents
* Checkout logic

---

## **[PF-077]— Define Order & Checkout Data Models (DB + GORM + Repo)**

## Type

Feature

## Description

Introduce all database models required to convert a CartRecord into durable orders. This ticket defines schema + ORM + repositories only. No checkout logic.

## Scope

* Define core checkout/order tables
* Add Goose migrations
* Add GORM models
* Add repository layer (CRUD + helpers)

## Acceptance Criteria

* [ ] Goose migrations create:

  * `checkout_groups`
  * `vendor_orders`
  * `order_line_items`
  * `payment_intents`
* [ ] All FKs + constraints match Data Design
* [ ] GORM models compile and migrate cleanly
* [ ] Repos expose basic create/fetch methods

## Dependencies

* Blocked by: Cart tickets (PF-074–076)
* Blocks: All checkout execution tickets

## Technical Notes

* Tables per **Doc 4**
* No business logic here
* Status enums MUST match MASTER CONTEXT
* **ASSUMPTION:** payment method defaults to `cash`

## Out of Scope

* Inventory reservation
* Checkout endpoint
* Outbox events

---

## **[PF-078] — Checkout Domain Helpers (Validation + Grouping + Totals)**

## Type

Task

## Description

Implement pure domain helpers used by checkout orchestration. These helpers MUST be deterministic and testable.

## Scope

* Cart → vendor grouping
* Totals recomputation helpers
* Validation helpers

## Acceptance Criteria

* [ ] Helper groups CartItems by `vendor_store_id`
* [ ] Per-vendor totals computed server-side
* [ ] Helpers validate (look at cart helpers for upsert-- abstract and use for both cart and checkout if needed):

  * buyer vs vendor store
  * state match
  * MOQ compliance
* [ ] Helpers are unit-testable without DB

## Dependencies

* Blocked by: PF-090
* Blocks: Checkout execution

## Technical Notes

* Location: `internal/checkout/helpers`
* No DB writes here
* Errors MUST use `pkg/errors`

## Out of Scope

* Inventory reservation
* Transactions
* Side effects

---

## **[PF-079] — Atomic Inventory Reservation Helper**

## Type

Feature

## Description

Implement atomic inventory reservation logic used during checkout. Must support partial success semantics.

## Scope

* Conditional inventory update
* Reservation result reporting per line item

## Acceptance Criteria

* [ ] Uses conditional UPDATE (`available_qty >= qty`)
* [ ] Never allows negative inventory
* [ ] Returns per-line reservation result
* [ ] Safe under concurrent checkouts
* [ ] Move to `reserved_qty`


## Dependencies

* Blocked by: PF-090
* Blocks: Checkout orchestration

## Technical Notes

* `inventory` & `product` tables
* SQL pattern from MASTER CONTEXT
* Executed inside caller transaction
* Retry-safe
* **ASSUMPTION:** reservation TTL handled later
* If Line items qty is no longer available continue to add it to the order but reject the line item and the reason - per-item.

## Out of Scope

* Reservation release
* Schedulers

---

## **[PF-080] — Checkout Orchestrator Service (Core Logic)**

## Type

Feature

## Description

Implement the core checkout execution service that converts a CartRecord into a CheckoutGroup and VendorOrders.

## Scope

* Checkout transaction orchestration
* Partial success handling
* Order creation

## Acceptance Criteria

* [ ] Single transaction per checkout attempt
* [ ] Creates CheckoutGroup exactly once
* [ ] Creates VendorOrders per vendor
* [ ] Creates OrderLineItems
* [ ] Failed reservations reject line items, not whole checkout
* [ ] Cart marked `converted`

## Dependencies

* Blocked by: PF-091, PF-092
* Blocks: API endpoint

## Technical Notes

* Location: `internal/checkout/service.go`
* Transaction boundary lives HERE
* Must be idempotency-aware (caller enforced)
* **ASSUMPTION:** synchronous execution (no goroutines)

## Out of Scope

* HTTP handling
* Notifications
* Analytics

---

## **[PF-081] — Checkout Idempotency Enforcement**

## Type

Task

## Description

Ensure checkout execution is exactly-once using Redis-backed idempotency.

## Scope

* Idempotency key validation
* Response replay
* Conflict detection

## Acceptance Criteria

* [ ] Same key returns identical CheckoutGroup + orders
* [ ] Duplicate body with same key returns 409
* [ ] Inventory not double-reserved
* [ ] TTL = 7 days

## Dependencies

* Blocked by: PF-093
* Blocks: Public checkout API

## Technical Notes

* Uses existing `middleware.Idempotency`
* Scope: `(userId, storeId, POST, /checkout)`
* Response cached after success

## Out of Scope

* Manual replay tools

---

## **[PF-082] — Emit `order_created` Outbox Event**

## Type

Task

## Description

Emit a domain event after successful checkout to notify vendors and analytics pipelines.

## Scope

* Write outbox rows
* Include CheckoutGroup + VendorOrder IDs

## Acceptance Criteria

* [ ] Outbox row written in same DB tx
* [ ] Event type = `order_created`
* [ ] Payload includes:

  * checkout_group_id
  * vendor_order_ids
* [ ] Publisher emits successfully

## Dependencies

* Blocked by: PF-093
* Blocks: Notifications, analytics

## Technical Notes

* Uses existing outbox infra
* Consumers MUST be idempotent

## Out of Scope

* Consumer implementations

---

## **[PF-083] — Checkout Submission Endpoint (`POST /api/v1/checkout`)**

## Type

Feature

## Description

Expose the checkout execution via a public API endpoint.

## Scope

* HTTP handler
* Auth + store validation
* Invoke checkout service
* Return structured response

## Acceptance Criteria

* [ ] Requires `Idempotency-Key`
* [ ] Returns created orders grouped by vendor
* [ ] Returns rejected vendors/line items explicitly
* [ ] Error codes map correctly (`422`, `409`)

## Dependencies

* Blocked by: PF-094, PF-095
* Blocks: Order lifecycle flows

## Technical Notes

* Route: `POST /api/v1/checkout`
* No business logic in controller
* Uses canonical error envelope

## Out of Scope

* Payment collection
* Vendor acceptance
