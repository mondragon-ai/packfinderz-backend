
## Title [PF-501]: Product model and database migrations

## Type

Feature

## Description

Define the canonical `products` data model for vendor listings and create the required Postgres migrations. This establishes the authoritative schema for all vendor products, including pricing, MOQ, and media attachment requirements.

## Scope

* Create `products` table per Doc 4 specification
* Enforce required fields, constraints, and indexes
* Ensure `media_id` (or attachment requirement) is enforced per product rules
* Add foreign key to vendor `stores`

## Acceptance Criteria

* [ ] Goose migration creates `products` table with all required columns and constraints
* [ ] Migration is idempotent and reversible where safe
* [ ] Product rows cannot exist without a vendor store owner
* [ ] Unit tests or migration verification confirms schema correctness

## Dependencies

* Blocked by: None
* Blocks: Vendor create/update product endpoints

## Technical Notes

* Table: `products`
* Enums: reuse existing enums where defined
* FK: `store_id → stores(id)`
* **ASSUMPTION:** Media is attached via `media_attachments`, not a direct FK column

## Out of Scope

* Product API endpoints
* Search indexing
* Media upload logic

---

## Title [PF-502]: Inventory model and database migrations

## Type

Feature

## Description

Introduce the `inventory_items` table to support optimistic inventory reservation and prevent overselling. Inventory is authoritative per product and updated atomically during checkout.

## Scope

* Create `inventory_items` table
* Enforce non-negative quantity constraints
* One-to-one relationship with `products`

## Acceptance Criteria

* [ ] Goose migration creates `inventory_items` table
* [ ] Each product can have at most one inventory row
* [ ] Constraints prevent negative available or reserved quantities
* [ ] Inventory row is deleted when product is deleted

## Dependencies

* Blocked by: PF-501
* Blocks: Inventory set endpoint, checkout flow

## Technical Notes

* Table: `inventory_items`
* PK: `product_id`
* Used by checkout atomic update logic
* **ASSUMPTION:** Inventory rows are created at product creation time

## Out of Scope

* Reservation logic
* TTL release logic
* Inventory analytics

---

## Title [PF-503]: Volume discount model and database migrations

## Type

Feature

## Description

Create a normalized volume discount model to support tiered pricing per product based on quantity thresholds.

## Scope

* Create `product_volume_discounts` table
* Enforce uniqueness per product and `min_qty`
* Support deterministic pricing evaluation

## Acceptance Criteria

* [ ] Goose migration creates `product_volume_discounts` table
* [ ] Unique constraint on `(product_id, min_qty)`
* [ ] Discounts can be queried ordered by `min_qty DESC`
* [ ] Schema matches Doc 4 specification

## Dependencies

* Blocked by: PF-501
* Blocks: Pricing validation at checkout

## Technical Notes

* Table: `product_volume_discounts`
* Pricing model uses `unit_price_cents`
* **ASSUMPTION:** Percent-off discounts are not supported in MVP

## Out of Scope

* Admin discount overrides
* Store-wide promotions
* Discount UI logic

---

## Title [PF-504]: Vendor create product endpoint

## Type

Feature

## Description

Implement the vendor-facing API endpoint to create new products, including validation of pricing, MOQ, inventory initialization, and media attachment requirements.

## Scope

* `POST /api/v1/vendor/products`
* Validate vendor store context and permissions
* Create product + inventory row in a single transaction
* Enforce required fields and invariants

## Acceptance Criteria

* [ ] Endpoint creates product owned by active vendor store
* [ ] Inventory row is initialized correctly
* [ ] Invalid payloads return canonical validation errors
* [ ] Idempotency-Key is enforced

## Dependencies

* Blocked by: PF-501, PF-502
* Blocks: Product management UI

## Technical Notes

* Controller: `api/controllers/products`
* Service: `internal/products`
* **ASSUMPTION:** Media is attached in a follow-up request, not inline

## Out of Scope

* Product updates
* Media upload
* Search indexing

---

## Title [PF-505]: Vendor update product endpoint (media immutable)

## Type

Feature

## Description

Implement vendor product updates while enforcing immutability of attached media and ownership constraints.

## Scope

* `PATCH /api/v1/vendor/products/{productId}`
* Allow updates to mutable fields only
* Enforce vendor ownership and role permissions

## Acceptance Criteria

* [ ] Media attachments cannot be changed via update
* [ ] Unauthorized updates are rejected with 403
* [ ] Updates persist correctly and return updated DTO
* [ ] Validation errors use canonical error envelope

## Dependencies

* Blocked by: PF-504
* Blocks: Vendor product management UX

## Technical Notes

* Media immutability enforced at service layer
* **ASSUMPTION:** Media changes require explicit attach/detach endpoints

## Out of Scope

* Media replacement
* Inventory updates
* Admin overrides

---

## Title [PF-506]: Vendor delete product endpoint

## Type

Feature

## Description

Allow vendors to permanently delete products they own, cascading inventory and attachments as appropriate.

## Scope

* `DELETE /api/v1/vendor/products/{productId}`
* Enforce ownership and permission checks
* Hard delete product and dependent rows

## Acceptance Criteria

* [ ] Product is removed from database
* [ ] Inventory row is deleted
* [ ] Orphaned media attachments are cleaned up or detached
* [ ] Endpoint returns 204 on success

## Dependencies

* Blocked by: PF-504
* Blocks: Product lifecycle completion

## Technical Notes

* FK cascades relied upon where defined
* **ASSUMPTION:** Orders referencing deleted products keep snapshot data

## Out of Scope

* Soft delete / archival
* Admin recovery

---

## Title [PF-507]: Inventory set endpoint (idempotent)

## Type

Feature

## Description

Provide a vendor-only endpoint to set available inventory quantities in an idempotent manner.

## Scope

* `PUT /api/v1/inventory/{productId}`
* Set `available_qty` explicitly
* Enforce idempotency and optimistic correctness

## Acceptance Criteria

* [ ] Endpoint updates inventory deterministically
* [ ] Idempotency-Key prevents duplicate effects
* [ ] Invalid quantities are rejected
* [ ] Vendor ownership is enforced

## Dependencies

* Blocked by: PF-502
* Blocks: Inventory management UI

## Technical Notes

* Table: `inventory_items`
* **ASSUMPTION:** Reserved quantity is never modified here

## Out of Scope

* Reservation logic
* Inventory deltas
* Bulk updates

---

## Title [PF-508]: MOQ validation (client + server)

## Type

Task

## Description

Ensure Minimum Order Quantity (MOQ) rules are enforced consistently on both client and server during cart and checkout flows.

## Scope

* Server-side validation during checkout
* Shared validation rules with frontend
* Canonical error responses on violation

## Acceptance Criteria

* [ ] Checkout fails with 422 when MOQ not met
* [ ] Error payload identifies offending product(s)
* [ ] Validation logic is unit-tested

## Dependencies

* Blocked by: PF-504
* Blocks: Checkout correctness

## Technical Notes

* MOQ stored on `products`
* **ASSUMPTION:** Client-side validation already exists or will mirror server logic

## Out of Scope

* Discount interactions
* Vendor overrides

---

## Title [PF-509]: Vendor visibility gating (license + subscription)

## Type

Feature

## Description

Enforce vendor visibility rules so only licensed and subscribed vendors appear in buyer-facing product search and browse endpoints.

## Scope

* Apply gating at query level
* Reuse canonical visibility rules
* Ensure no leakage via direct product access

## Acceptance Criteria

* [ ] Unverified vendors never appear in search
* [ ] Lapsed subscriptions hide vendor listings immediately
* [ ] Buyer access to hidden vendors returns 404/422

## Dependencies

* Blocked by: License + subscription models
* Blocks: Marketplace correctness

## Technical Notes

* Tables: `stores`, `subscriptions`
* Applied in `/products` and vendor directory queries
* **ASSUMPTION:** Gating is enforced server-side only

## Out of Scope

* Admin preview access
* Caching strategies

---

## Title [PF-510]: Product audit logging

## Type

Task

## Description

Emit audit log entries for critical product lifecycle actions to ensure traceability and compliance.

## Scope

* Log product create, update, delete actions
* Include actor, store, and target metadata
* Append-only audit records

## Acceptance Criteria

* [ ] Audit logs written for create/update/delete
* [ ] Logs include actor_user_id and store context
* [ ] No sensitive fields are logged

## Dependencies

* Blocked by: PF-504
* Blocks: Compliance readiness

## Technical Notes

* Table: `audit_logs`
* Action names must be deterministic
* **ASSUMPTION:** Audit logging helper already exists

## Out of Scope

* Analytics ingestion
* Admin UI for audit logs

---

If you want, next we can:

* Convert these into **Phase 5 implementation order**
* Generate **Codex/Claude code-generation prompts per ticket**
* Or do **Phase 6 — Orders & Checkout** in the same rigor
