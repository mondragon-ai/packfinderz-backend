# Title [PF-234]: Create one payment_intent per vendor order inside checkout transaction

## Type

Feature

## Description

Create exactly one `payment_intent` per vendor order as part of the checkout transaction. This ensures payment state is vendor-scoped, retry-safe, and atomically consistent with order creation.

## Scope

* Create a `payment_intent` row for each `vendor_order`
* Perform creation inside the same DB transaction as checkout conversion
* Ensure idempotency on retries (no duplicate intents)

**Explicitly NOT included**

* Payment capture/settlement
* Refund handling
* External payment provider calls

## Acceptance Criteria

* [ ] Each vendor order has exactly one associated payment_intent
* [ ] Retries do not create duplicate payment_intents
* [ ] payment_intent creation is rolled back if checkout fails
* [ ] If payment method is ach must initiate a transaction (future feature) -> move status to pending if ach initiated otherwise unpaid (or failed)
* [ ] If payment method is cash must move status to unpaid
* [ ] Add enum to status as failed or rejected for future ach roll outs. 
* [ ] add feature flag to allow for ach or not in env vars (add var to env.example file as well)

## Dependencies

* Blocked by: Vendor order creation logic
* Blocks: PF-234

## Technical Notes

* Table: `payment_intents`
* FK: `payment_intents.vendor_order_id`
* **ASSUMPTION:** checkout transaction already spans cart → vendor orders

## Out of Scope

* Payment status transitions
* Multi-intent per vendor order

---

# Title [INCOMPLETE ❌] [PF-235]: Set payment intent amount and payment method from checkout confirmation

## Type

Feature

## Description

Populate payment intent fields deterministically from checkout-confirmed data. The amount must reflect the final vendor order total, and the payment method must match the method confirmed at checkout.

## Scope

* Set `payment_intent.amount_cents = vendor_orders.total_cents`
* Set `payment_intent.payment_method` from checkout-confirmed method
* Enforce immutability after creation

**Explicitly NOT included**

* Payment method validation
* Partial payments or adjustments

## Acceptance Criteria

* [ ] payment_intent.amount_cents equals vendor_orders.total_cents
* [ ] payment_intent.payment_method matches checkout-confirmed value
* [ ] Fields are not mutated on retries

## Dependencies

* Blocked by: PF-233
* Blocks: None

## Technical Notes

* Values set during initial insert only
* **ASSUMPTION:** checkout-confirmed payment_method is authoritative

## Out of Scope

* Currency conversion
* Discounts or credits

---

# Title [INCOMPLETE ❌] [PF-239]: Add repository helper to fetch full checkout result by checkout_group_id

## Type

Task

## Description

Add a repository helper to fetch the complete checkout result by `checkout_group_id`, including vendor orders, payment intents, and relevant metadata. This supports post-checkout flows and tests.

## Scope

* Implement repo helper query by `checkout_group_id`
* Join vendor_orders, payment_intents, and related entities
* Return a structured aggregate result

**Explicitly NOT included**

* API endpoint exposure
* Pagination or filtering

## Acceptance Criteria

* [ ] Helper returns all vendor orders for the checkout_group_id
* [ ] Associated payment_intents are included
* [ ] Helper returns empty result when checkout_group_id is unknown

## Dependencies

* Blocked by: Vendor orders and payment intents schema
* Blocks: PF-245

## Technical Notes

* Repo: `internal/checkout` or equivalent
* **ASSUMPTION:** checkout_group_id uniquely identifies a checkout

## Out of Scope

* Authorization checks
* Caching

---

# Title [INCOMPLETE ❌] [PF-240]: Emit Notifications outbox event for checkout conversion

## Type

Feature

## Description

Define and emit a Notifications outbox event when checkout is successfully converted. The event must be written in the same transaction as vendor order creation to ensure exactly-once-ish semantics.

## Scope

* Define/extend outbox payload for `checkout_converted` (Notifications)
* Emit outbox row in the checkout transaction
* Include identifiers required for downstream notification delivery

**Explicitly NOT included**

* Notification delivery logic
* Template rendering

## Acceptance Criteria

* [ ] Notifications outbox event is written on successful checkout conversion
* [ ] Event is written in the same DB transaction as vendor orders
* [ ] Retries do not create duplicate notification events

## Dependencies

* Blocked by: Outbox infrastructure
* Blocks: PF-245

## Technical Notes

* Event type: `checkout_converted`
* **ASSUMPTION:** notification consumers are idempotent

## Out of Scope

* Push/email channel selection
* User preferences

---

# Title [INCOMPLETE ❌] [PF-241]: Emit Analytics outbox event for checkout conversion with attribution

## Type

Feature

## Description

Define and emit an Analytics outbox event for checkout conversion, including cart totals and attribution ad tokens. This event must be written atomically with cart conversion.

## Scope

* Define/extend analytics outbox payload schema
* Include cart totals and attribution `ad_tokens`
* Emit outbox row in the cart conversion transaction

**Explicitly NOT included**

* Analytics aggregation or reporting
* Ad spend calculations

## Acceptance Criteria

* [ ] Analytics outbox event includes cart totals and ad_tokens
* [ ] Event is written in the same transaction as cart conversion
* [ ] Retries do not produce duplicate analytics events

## Dependencies

* Blocked by: Cart conversion logic
* Blocks: PF-245

## Technical Notes

* Event type: `checkout_converted`
* Payload versioning applies
* **ASSUMPTION:** ad_tokens are already validated upstream

## Out of Scope

* Cross-session attribution logic
* Analytics dashboards

---

# Title [INCOMPLETE ❌] [PF-236]: Prevent duplicate vendor orders on checkout retry

## Type

Bug

## Description

Prevent duplicate vendor orders from being created when checkout is retried. Uniqueness must be anchored on stable identifiers to guarantee idempotency.

## Scope

* Enforce uniqueness on vendor order creation
* Anchor uniqueness on:

  * `checkout_group_id + vendor_store_id` and/or
  * `cart_id`
* Ensure retries return existing vendor orders

**Explicitly NOT included**

* Cleanup of historical duplicates
* Manual reconciliation tools

## Acceptance Criteria

* [ ] Retries do not create additional vendor orders
* [ ] Existing vendor orders are reused on retry
* [ ] Violations are prevented at DB or service layer

## Dependencies

* Blocked by: PF-233
* Blocks: PF-245

## Technical Notes

* Prefer DB-level unique constraint where possible
* **ASSUMPTION:** checkout_group_id is stable across retries

## Out of Scope

* Multi-cart merging
* Vendor order edits

---

# Title [INCOMPLETE ❌] [PF-238]: Prevent duplicate outbox rows on checkout conversion retry

## Type

Bug

## Description

Ensure outbox events emitted during checkout conversion are not duplicated on retries. Each logical conversion should emit at most one outbox row per event type.

## Scope

* Add idempotency guard for outbox inserts
* Anchor uniqueness on conversion identifiers
* Ensure retries reuse existing outbox rows

**Explicitly NOT included**

* Outbox dispatcher behavior
* DLQ handling

## Acceptance Criteria

* [ ] Retries do not insert duplicate outbox rows
* [ ] Existing outbox rows are reused or detected
* [ ] Exactly one outbox row per event type per conversion

## Dependencies

* Blocked by: Outbox schema
* Blocks: PF-245

## Technical Notes

* Possible anchor: `checkout_group_id + event_type`
* **ASSUMPTION:** outbox table supports uniqueness constraints or guarded inserts

## Out of Scope

* Deduplication in consumers
* Replay tooling

---

# Title [INCOMPLETE ❌] [PF-244]: Define outbox payload versioning rules for checkout events

## Type

Chore

## Description

Define explicit versioning rules for checkout-related outbox payloads to allow safe evolution of event schemas without breaking consumers.

## Scope

* Define version field or convention in payload
* Document rules for backward-compatible changes
* Apply rules to checkout-converted events

**Explicitly NOT included**

* Automatic schema migration
* Consumer-side enforcement

## Acceptance Criteria

* [ ] Payload versioning rules are documented
* [ ] Checkout outbox payloads include a version indicator
* [ ] Rules are applied consistently across events

## Dependencies

* Blocked by: PF-240, PF-241
* Blocks: None

## Technical Notes

* Versioning may be numeric or semantic
* **ASSUMPTION:** consumers tolerate additive fields

## Out of Scope

* Version negotiation
* Schema registry

---

# Title [INCOMPLETE ❌] [PF-245]: Add checkout regression tests for idempotency and outbox emission

## Type

Task

## Description

Add regression tests covering checkout idempotency, expired/already converted cart behavior, and exact outbox emission counts. These tests lock the core checkout contract.

## Scope

* Tests for:

  * Idempotent checkout retries
  * Expired cart rejection
  * Already converted cart behavior
  * Exactly two outbox events emitted (Notifications + Analytics)
* Use real transaction boundaries where possible

**Explicitly NOT included**

* Load testing
* End-to-end UI tests

## Acceptance Criteria

* [ ] Retried checkout produces no duplicates
* [ ] Expired carts are rejected deterministically
* [ ] Converted carts cannot be re-converted
* [ ] Exactly two outbox rows are created per successful checkout

## Dependencies

* Blocked by: PF-233, PF-236, PF-238, PF-240, PF-241
* Blocks: None

## Technical Notes

* Tests should assert DB state directly
* **ASSUMPTION:** test environment supports transactional rollback

## Out of Scope

* Performance benchmarks
* Chaos testing
