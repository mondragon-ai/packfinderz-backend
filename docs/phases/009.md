## Title [PF-093]: Enable agent identity via system_role and validate auth flow

## Type

Feature

## Description

Ensure the platform supports internal delivery agents end-to-end by enabling users with `users.system_role = 'agent'` to authenticate, receive JWTs, and pass through middleware gating correctly. This establishes the foundation for all agent-specific APIs.

## Scope

* Support agent users with `system_role=agent`
* Allow agent login and token issuance
* Ensure middleware correctly authorizes agent-only routes

## Acceptance Criteria

* [ ] A user with `system_role=agent` can log in successfully
* [ ] Issued JWT includes `role=agent`
* [ ] Agent requests are rejected if accessing non-agent routes
* [ ] Non-agent users cannot access `/api/agent/*` routes

## Dependencies

* Blocked by: Auth system + JWT middleware
* Blocks: All agent route implementations

## Technical Notes

* Uses `users.system_role`
* Middleware: `RequireRole("agent")`
* JWT claims must surface role correctly
* **ASSUMPTION:** Agent users are pre-seeded manually for MVP

## Out of Scope

* Agent onboarding UI
* Role switching for agents

---

## Title [PF-802]: Add agent API route group and base controllers

## Type

Task

## Description

Create the `/api/v1/agent/*` route group with required middleware and baseline controller wiring. This establishes a protected namespace for all agent operations.

## Scope

* Add `/api/v1/agent` router group
* Apply auth + role middleware
* Add health/ping endpoint for agents
* Add test coverage for access control

## Acceptance Criteria

* [ ] `/api/v1/agent/ping` responds for agent users
* [ ] Non-agent users receive 403
* [ ] Middleware enforces agent role
* [ ] Route group included in main router

## Dependencies

* Blocked by: PF-801
* Blocks: All agent endpoints

## Technical Notes

* Router: `api/routes`
* Middleware: auth → store context (optional) → `RequireRole("agent")`
* **ASSUMPTION:** Agents may operate without `activeStoreId`

## Out of Scope

* Business logic inside agent endpoints

---

## Title [PF-803]: Create order_assignments migration

## Type

Infra

## Description

Add the `order_assignments` table to persist agent-to-order assignments, including reassignment history and active assignment enforcement.

## Scope

* Create Goose migration for `order_assignments`
* Add indexes and constraints per data design
* Ensure reversibility where feasible

## Acceptance Criteria

* [ ] Migration creates `order_assignments` table
* [ ] Enforces one active agent per order
* [ ] Foreign keys and indexes match spec
* [ ] Migration runs cleanly in dev

## Dependencies

* Blocked by: None
* Blocks: Agent assignment service

## Technical Notes

* Table per Doc 4 §2.16
* Unique constraint: `(order_id) WHERE active = true`
* **ASSUMPTION:** No reassignment UI in MVP

## Out of Scope

* Assignment logic
* Admin override endpoints

---

## Title [PF-804]: Auto-assign agent on order ready for dispatch

## Type

Feature

## Description

When a vendor order transitions to `hold` (ready for pickup), automatically assign a random available agent and create an active `order_assignments` row.

## Scope

* Detect transition to `hold`
* Select agent (random MVP)
* Persist assignment atomically
* Prevent duplicate assignments

## Acceptance Criteria

* [ ] Assignment is created when order enters `hold`
* [ ] Only one active assignment exists per order
* [ ] Assignment creation is idempotent
* [ ] Failures do not block order state transition

## Dependencies

* Blocked by: PF-803
* Blocks: Agent queue visibility

## Technical Notes

* Implement in `internal/orders` or `internal/agents` service
* Triggered from vendor fulfillment flow
* **ASSUMPTION:** All agents are always available (no availability model yet)

## Out of Scope

* Manual reassignment
* Agent load balancing

---

## Title [PF-805]: List unassigned orders for agent dispatch queue

## Type

Feature

## Description

Expose an endpoint for agents to view orders in `hold` status that are not yet assigned to any agent.

## Scope

* `GET /api/v1/agent/orders/queue`
* Return orders with `status=hold` and no active assignment
* Paginated response

## Acceptance Criteria

* [ ] Endpoint returns only unassigned hold orders
* [ ] Non-agent users receive 403
* [ ] Pagination works as expected
* [ ] Response includes order summary metadata

## Dependencies

* Blocked by: PF-802, PF-803
* Blocks: Agent pickup flow

## Technical Notes

* Query joins `vendor_orders` + `order_assignments`
* Filter: no active assignment
* **ASSUMPTION:** Queue visibility is global (not agent-specific)

## Out of Scope

* Assignment from queue (auto-assign already handled)

---

## Title [PF-806]: List active assignments for agent

## Type

Feature

## Description

Allow agents to view their currently assigned orders.

## Scope

* `GET /api/v1/agent/orders`
* Return orders with active assignment for the agent user
* Paginated response

## Acceptance Criteria

* [ ] Endpoint returns only orders assigned to agent
* [ ] Orders include status and delivery metadata
* [ ] Non-agent users receive 403

## Dependencies

* Blocked by: PF-803
* Blocks: Pickup and delivery actions

## Technical Notes

* Join `order_assignments` → `vendor_orders`
* Filter by `agent_user_id`
* **ASSUMPTION:** One active assignment per order

## Out of Scope

* Historical assignments

---

## Title [PF-807]: Agent pickup order (in_transit transition)

## Type

Feature

## Description

Allow an assigned agent to mark an order as picked up, transitioning it to `in_transit`.

## Scope

* `POST /api/v1/agent/orders/{orderId}/pickup`
* Validate assignment ownership
* Update order status

## Acceptance Criteria

* [ ] Only assigned agent can pick up order
* [ ] Order transitions from `hold` → `in_transit`
* [ ] Idempotent requests are supported
* [ ] Invalid state transitions return 422

## Dependencies

* Blocked by: PF-806
* Blocks: Delivery completion

## Technical Notes

* Update `vendor_orders.status`
* Use idempotency middleware
* **ASSUMPTION:** Pickup time not separately tracked

## Out of Scope

* GPS tracking
* Pickup confirmation artifacts

---

## Title [PF-808]: Agent deliver order (delivered transition)

## Type

Feature

## Description

Allow an assigned agent to mark an order as delivered.

## Scope

* `POST /api/v1/agent/orders/{orderId}/deliver`
* Validate assignment ownership
* Update delivery timestamps

## Acceptance Criteria

* [ ] Only assigned agent can deliver order
* [ ] Order transitions to `delivered`
* [ ] Delivered timestamp recorded
* [ ] Idempotent behavior enforced

## Dependencies

* Blocked by: PF-807
* Blocks: Cash collection

## Technical Notes

* Update `vendor_orders.delivered_at`
* State validation required
* **ASSUMPTION:** Delivery confirmation requires no signature

## Out of Scope

* Proof-of-delivery capture

---

## Title [PF-809]: Record cash collection and settle payment

## Type

Feature

## Description

Allow agents to record cash collection upon delivery, settling the payment and creating a ledger event.

## Scope

* `POST /api/v1/agent/orders/{orderId}/cash-collected`
* Create `ledger_events` row
* Update `payment_intents`
* Emit outbox event

## Acceptance Criteria

* [ ] Ledger event `cash_collected` is created
* [ ] Payment intent status set to `settled`
* [ ] `cash_collected_at` timestamp recorded
* [ ] Outbox event `cash_collected` emitted
* [ ] Idempotent behavior enforced

## Dependencies

* Blocked by: PF-808
* Blocks: Admin payout confirmation

## Technical Notes

* Must run in DB transaction
* Ledger is append-only
* Outbox written in same transaction
* **ASSUMPTION:** Cash amount equals `balance_due_cents`

## Out of Scope

* Partial cash collection
* Refund handling
