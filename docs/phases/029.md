# Title [PF-255]: Finalize shared Square client wrapper (`pkg/square`)

## Type

Feature

## Description

Implement and finalize a shared Square client wrapper in `pkg/square` to replace ad-hoc and stubbed Square usage. The wrapper must centralize auth/env config, idempotency key conventions, request/response logging with strict PII redaction, and unified error mapping to domain-safe errors. This wrapper will be used by API, workers, and webhook flows.

## Scope

* Implement shared Square client wrapper (`pkg/square`)

* Centralize:

  * Auth/env validation (access token, environment)
  * Idempotency key generation conventions
  * Request/response logging with PII redaction
  * Error mapping from Square SDK → domain errors

* Expose primitives needed by billing/subscriptions (customer, card, subscription, payment)

* NOT included:

  * Any business logic (subscriptions, plans, billing rules)
  * Any API endpoints or migrations

## Acceptance Criteria

* [ ] All Square interactions are available via `pkg/square` wrapper methods
* [ ] Logs emitted from wrapper redact tokens, card data, and PII
* [ ] Errors from Square SDK are mapped to deterministic domain errors

## Dependencies

* Blocked by: None
* Blocks: PF-XXX, PF-XXX, PF-XXX, PF-XXX, PF-XXX

## Technical Notes

* Relevant: `pkg/square/client.go`, Square SDK
* Wrapper must be safe for use in API + worker binaries
* **ASSUMPTION:** Square SDK is already vendored and approved for use

## Out of Scope

* Billing plan logic
* Subscription lifecycle orchestration
* DB modifications

---

# Title [PF-256]: Replace Square subscription stub with real Square-backed client

## Type

Feature

## Description

Replace the stubbed `internal/subscriptions/square_client.go` with a real Square-backed implementation behind an interface. Refactor `internal/subscriptions.Service` to depend on the shared `pkg/square` wrapper. Retain the stub implementation only for tests.

## Scope

* Replace stubbed SquareSubscriptionClient with real implementation
* Introduce interface boundary for Square subscription operations
* Refactor `internal/subscriptions.Service` to use `pkg/square`
* Keep stub implementation for tests only

* NOT included:

  * Subscription endpoints
  * Webhook changes

## Acceptance Criteria

* [ ] No production path uses the stubbed Square client
* [ ] Subscription create/cancel/pause/resume flows call real Square APIs via wrapper
* [ ] Tests can still use stubbed implementation

## Dependencies

* Blocked by: PF-XXX
* Blocks: PF-XXX, PF-XXX

## Technical Notes

* Relevant: `internal/subscriptions/service.go`, `pkg/square`
* **ASSUMPTION:** Existing subscription service interfaces remain stable

## Out of Scope

* Plan selection logic
* Card-on-file handling

---

#  Title [PF-257]: Persist Square customer identifiers on Store

## Type

Feature

## Description

Add database migration(s) and model updates to persist Square identifiers required for billing flows, starting with `stores.square_customer_id`. Update store repository helpers to read/write this field.

## Scope

* Goose migration to add `square_customer_id` to stores
* GORM model update
* Repo helper updates

* NOT included:

  * Square customer creation logic
  * Registration flow changes

## Acceptance Criteria

* [ ] Stores table contains `square_customer_id`
* [ ] Store repo can persist and fetch Square customer ID
* [ ] No existing store flows break

## Dependencies

* Blocked by: None
* Blocks: PF-XXX, PF-XXX

## Technical Notes

* Relevant: `internal/stores/repo.go`, Goose migrations
* **ASSUMPTION:** Backfill is not required for existing stores

## Out of Scope

* Card or subscription persistence

---

# Title [PF-258]: Refactor subscriptions persistence to enforce 0..1 subscription per store

## Type

Feature

## Description

Refactor and extend the `subscriptions` table and models to enforce a strict 0..1 subscription relationship per store. Add missing linkage fields and lifecycle timestamps while preserving existing data.

## Scope

* Goose migration to:

  * Add `billing_plan_id`, `square_customer_id`, `square_card_id`
  * Add lifecycle timestamps (paused_at, canceled_at)
  * Add unique index on `store_id`

* Update GORM model and repo helpers

* NOT included:

  * Subscription API endpoints
  * Webhook logic

## Acceptance Criteria

* [ ] Database enforces zero or one subscription per store
* [ ] Subscription model includes required linkage fields

## Dependencies

* Blocked by: PF-XXX
* Blocks: PF-XXX, PF-XXX

## Technical Notes

* Relevant: `pkg/db/models/subscription.go`
* **ASSUMPTION:** Existing data volume is small and migration-safe

## Out of Scope

* Billing plan table

---

# Title [PF-259]: Implement Square customer creation and registration integration

## Type

Feature

## Description

Implement Square customer creation via service helper and internal/admin endpoint, and integrate customer creation into `POST /api/v1/auth/register`. The flow must be idempotent and handle partial failures safely.

## Scope

* Square customer creation helper via `pkg/square`
* Internal/admin endpoint to create or fetch customer
* Registration flow integration
* Compensation strategy for partial failures

* NOT included:

  * Card-on-file
  * Subscription creation

## Acceptance Criteria

* [ ] Register flow creates or reuses Square customer idempotently (use store owner first & last name, email, & store address, phone, company_name) be sure to map registration DTO to the customer requried DTO for square
* [ ] `square_customer_id` is persisted on store record
* [ ] Partial failures leave store in consistent state

## Dependencies

* Blocked by: PF-XXX, PF-XXX
* Blocks: PF-XXX, PF-XXX

## Technical Notes

* Relevant: `api/controllers/auth/register`, `pkg/square`
* **ASSUMPTION:** Square customer creation is free and safe to retry

## Out of Scope

* Billing plans
* Card storage

---

# Title [PF-260]: Implement card-on-file flow (Square Web Payments SDK → backend) 

## Type

Feature

## Description

Implement end-to-end card-on-file flow: tokenize card via Square Web Payments SDK in Next.js, send token to backend, create card in Square, and persist card metadata in `payment_methods`.

## Scope

* Frontend tokenization (Square Web Payments SDK)
* Backend endpoint to store card via Square Cards API
* Upsert into `payment_methods`
* Enforce one active/default card per store
* Response should return retracted version of the payment method + HTTP codes
* If only one PM available, make default otherwise `is_default` will be an argument in the body (default false)
* On DB failure leave the Square Card created
* the token will be returned from the SDK and then sstored client side in state and that will automatically call our backend endpoint to save save the card info in a payment method
* ONLY store payment information in the payment_method record 0..many methods

* NOT included:

  * Subscription creation
  * Usage billing

## Acceptance Criteria

* [ ] Vendor can add a card and see it stored
* [ ] Only one active/default card exists per store
* [ ] Card metadata is persisted correctly
* [ ] API endpoint for accepting the token allows to update / create payment method. 

## Dependencies

* Blocked by: PF-XXX, PF-XXX
* Blocks: PF-XXX, PF-XXX

## Technical Notes

* Relevant: `payment_methods` table, Next.js frontend
* **ASSUMPTION:** CSP constraints are deferred/ignored for now

## Out of Scope

* Multiple card management UI
* Card deletion

---

# Title [PF-261]: Add billing_plans table, model, and repository

## Type

Feature

## Description

Introduce `billing_plans` as a first-class local source of truth for subscription plans, including Square mapping IDs, pricing, trial metadata, and UI metadata.

## Scope

* Goose migration for `billing_plans`
* GORM model
* Repo/service for CRUD and list/query
* Indexes on status, is_default, Square IDs

* NOT included:

  * API endpoints
  * Square Catalog creation

## Acceptance Criteria

* [ ] `billing_plans` table exists with required fields
```sql
-- =========================
-- ENUMS
-- =========================

CREATE TYPE billing_interval AS ENUM (
  'EVERY_30_DAYS',
  'ANNUAL'
);

CREATE TYPE plan_status AS ENUM (
  'active',
  'deprecated',
  'hidden'
);

CREATE TYPE ui_badge AS ENUM (
  'popular',
  'best_value',
  'new'
);

-- =========================
-- BILLING PLANS
-- =========================

CREATE TABLE billing_plans (
  id TEXT PRIMARY KEY,              -- "starter_v1"
  name TEXT NOT NULL,
  status plan_status NOT NULL,
  square_billing_plan_id TEXT NOT NULL,       -- This is the prodcut or subscritpion plan id from Square used to generate the sub contract with customers

  test BOOLEAN DEFAULT FALSE,
  is_default BOOLEAN DEFAULT FALSE,

  -- Trial (embedded object)
  trial_days INTEGER DEFAULT 0,
  trial_require_payment_method BOOLEAN DEFAULT FALSE,
  trial_start_on_activation BOOLEAN DEFAULT TRUE,

  -- Subscription Component
  interval billing_interval NOT NULL,

  price_amount NUMERIC(12,2) NOT NULL,      -- Money.amount
  currency_code TEXT NOT NULL,              -- USD / BRL / EUR / GBP / custom

  features TEXT[],                          -- optional feature gates

  -- UI metadata (flexible)
  ui JSONB,                                 -- { badge, description, bullets }

  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- =========================
-- OPTIONAL INDEXES
-- =========================

CREATE INDEX idx_billing_plans_status ON billing_plans(status);
CREATE INDEX idx_billing_plans_default ON billing_plans(is_default);

-- Example UI JSON:
-- {
--   "badge": "popular",
--   "description": "Best for growing teams",
--   "bullets": ["Unlimited products", "Priority support"]
-- }


```
* [ ] Repo can create, update, list plans
* [ ] Default plan can be queried deterministically

## Dependencies

* Blocked by: None
* Blocks: PF-XXX, PF-XXX

## Technical Notes

* Relevant: `internal/billing`
* **ASSUMPTION:** Square plan IDs are provisioned manually initially

## Out of Scope

* Vendor subscription flows

---

# Title [PF-262]: Implement BillingPlan admin and vendor APIs

## Type

Feature

## Description

Expose BillingPlan APIs: admin CRUD (create/update/disable) and vendor read-only list/get of active plans.

## Scope

* Admin-only endpoints for BillingPlan management
* Vendor read-only endpoints for active plans
* RBAC enforcement

* NOT included:

  * Subscription creation
  * Square Catalog mutations

## Acceptance Criteria

* [ ] Admin can manage billing plans (create, modify, or delete)
* [ ] If possible, please use the Square API/SDK to create the plan as well and save those credentials to the billing plan record (this is used to create the subscription contract) OR allow the create API to receive the nvecessary info from square to link the billing plan to square subscription selling plan item.
* [ ] Vendors can list and view active/available plans only
* [ ] Permissions are enforced when necessary

## Dependencies

* Blocked by: PF-XXX
* Blocks: PF-XXX

## Technical Notes

* Relevant: `api/routes`, `internal/billing`
* **ASSUMPTION:** Admin role already exists and is enforced elsewhere

## Out of Scope

* Plan migrations between subscriptions

---

# Title [PF-163]: Implement vendor subscription lifecycle endpoints

## Type

Feature

## Description

Implement/extend/Refactor vendor-facing subscription lifecycle endpoints using stored Square customer, card, and billing plan mapping. Ensure persistence and store subscription state remain aligned.

## Scope

* Create subscription
* Get current subscription
* Cancel, pause, resume subscription
* Persist state transitions
* Maintain `store.SubscriptionActive`

* NOT included:

  * Webhook reconciliation
  * Usage billing

## Acceptance Criteria

* [ ] Vendor can create subscription with valid plan and card
* [ ] Subscription lifecycle transitions persist correctly
* [ ] Store subscription flag reflects active state

## Dependencies

* Blocked by: PF-XXX, PF-XXX, PF-XXX, PF-XXX
* Blocks: PF-XXX

## Technical Notes

* Relevant: `internal/subscriptions.Service`, `subscriptions`, `stores`, `payment_methods`
* **ASSUMPTION:** Only one active subscription per store

## Out of Scope

* Subscription upgrades/downgrades

---

# Title [PF-164]: Harden Square webhook reconciliation for subscriptions

## Type

Feature

## Description

Harden Square webhook handling for subscription and invoice events. Remove brittle metadata dependencies, ensure idempotency, and make status mapping forward-compatible.

## Scope

* Expand webhook handling for `subscription.*` and relevant `invoice.*`
* Fallback lookup by `square_subscription_id`
* Safe status mapping
* Preserve Redis idempotency guard

* NOT included:

  * Payment processing
  * Usage billing

## Acceptance Criteria

* [ ] Webhooks do not fail when metadata is missing
* [ ] Duplicate events are safely ignored
* [ ] New Square statuses do not crash handlers
* [ ] subscription & store subscription status are updated correctly if a subscription is created, charged successfully, failed, paused, canceled, or resumed. 


## Dependencies

* Blocked by: PF-XXX, PF-XXX
* Blocks: PF-XXX

## Technical Notes

* Relevant: `internal/webhooks/square`
* **ASSUMPTION:** Square webhook schema remains backward compatible

## Out of Scope

* DLQ/replay tooling

---

# [INCOMPLETE ❌] Title [PF-165]: Implement ad usage charges persistence and listing

## Type

Feature

## Description

Make `usage_charges` real by persisting ad usage billing outcomes and exposing them via existing billing endpoints.

## Scope

* Persist ad usage billing outcomes into `usage_charges` table
* Ensure typing/status enums are consistent
* Integrate with `/vendor/billing/charges` pagination

* NOT included:

  * Worker job
  * Square payment execution

## Acceptance Criteria

* [ ] Usage charges are written to DB
* [ ] Charges are visible via vendor billing API
* [ ] Status enums are consistent

## Dependencies

* Blocked by: PF-XXX
* Blocks: PF-XXX

## Technical Notes

* Relevant: `usage_charges`, `charges`
* **ASSUMPTION:** Ad counters exist elsewhere and are correct

## Out of Scope

* Retry logic

---

# [INCOMPLETE ❌] Title [PF-166]: Implement nightly ad usage billing worker

## Type

Feature

## Description

Implement nightly worker job to roll up per-store ad spend, charge via Square using card-on-file, and persist usage charges. Apply failure policies.

## Scope

* Worker job inside existing worker binary
* Roll up ad spend per store
* Create Square payment
* Persist `usage_charges`
* Apply failure handling (past_due, ads disabled)

* NOT included:

  * UI changes
  * Manual retry tooling

## Acceptance Criteria

* [ ] Nightly job runs and charges eligible stores
* [ ] Failures mark store billing state correctly
* [ ] Successful charges persist usage records

## Dependencies

* Blocked by: PF-XXX, PF-XXX
* Blocks: PF-XXX

## Technical Notes

* Relevant: worker binary, Square payments
* **ASSUMPTION:** Ad spend counters are available at runtime

## Out of Scope

* DLQ replay

---

# Title [PF-167]: Add billing permissions, guards, and PII redaction enforcement

## Type

Chore

## Description

Add final billing-related permissions and enforce PII redaction across API, worker, and webhook billing paths.

## Scope

* Admin-only plan management guards
* Vendor role checks for card/subscription actions
* PII redaction enforcement in logs

* NOT included:

  * New roles
  * Audit logging

## Acceptance Criteria

* [ ] Unauthorized billing actions are rejected
* [ ] Billing logs contain no PII
* [ ] Guards apply consistently across services

## Dependencies

* Blocked by: PF-XXX, PF-XXX
* Blocks: None

## Technical Notes

* Relevant: middleware, logging utilities
* **ASSUMPTION:** Existing RBAC primitives are sufficient

## Out of Scope

* Compliance/audit trails

