## **Title [PF-102]: Create append-only `ledger_events` table and indexes**

## **Type**

Infra

## **Description**

Create the authoritative, append-only `ledger_events` table used to record all money lifecycle events (cash collection, vendor payouts, future adjustments). This table is the source of truth for financial auditability and must never allow updates or deletes to existing rows.

## **Scope**

* Create `ledger_events` table per Master Context
* Add required indexes for order-centric and type-centric queries
* Enforce append-only behavior at the application level

## **Acceptance Criteria**

* [ ] `ledger_events` table exists with required fields and types
* [ ] Index exists on `(order_id, created_at)`
* [ ] Index exists on `(type, created_at)`
* [ ] No application path performs UPDATE or DELETE on ledger rows

## **Dependencies**

* Blocked by: None
* Blocks: PF-XXX, PF-XXX

## **Technical Notes**

* Table shape (authoritative):

  * `id (uuid, pk)`
  * `order_id (uuid, fk → vendor_orders.id)`
  * `type ENUM not null` (`cash_collected|vendor_payout|adjustment|refund` future)
  * `amount_cents (int)`
  * `metadata (jsonb, nullable)`
  * `created_at (timestamptz)`
* FK MUST be `ON DELETE RESTRICT`
* **ASSUMPTION:** append-only enforcement is handled by code review + service discipline (no DB trigger in MVP)

## **Out of Scope**

* Ledger aggregation or reporting
* Editing or reversing ledger events

---

## **Title [PF-103]: Implement ledger event append helpers (repo + service)**

## **Type**

Task

## **Description**

Introduce repository and service-layer helpers to append ledger events in a single, consistent way. These helpers ensure ledger rows are only ever inserted and never mutated.

## **Scope**

* Repository function to insert ledger events
* Service-level helper wrapping ledger insertion
* Reusable across cash collection and payout flows

## **Acceptance Criteria**

* [ ] Helper exists to append a ledger event with type, amount, orderId
* [ ] Helper performs INSERT only (no update paths)
* [ ] Helper is used by payout confirmation logic

## **Dependencies**

* Blocked by: PF-XXX
* Blocks: PF-XXX

## **Technical Notes**

* Location:

  * Repo: `internal/ledger/repo`
  * Service: `internal/ledger/service`
* Ledger writes SHOULD occur inside the same DB transaction as payment/order state transitions
* **ASSUMPTION:** metadata is optional and minimal in MVP

## **Out of Scope**

* Ledger querying APIs
* Aggregation logic

---

## **Title [PF-104]: Admin payout queue endpoint**

## **Type**

Feature

## **Description**

Expose an admin-only endpoint to list vendor orders eligible for payout. This enables operational review before confirming vendor payments.

## **Scope**

* Implement `GET /api/v1/admin/orders/payouts` -> list of orders that are eligable
* Implement `GET /api/v1/admin/orders/payouts/{orderID}` -> Order detail for a payout (to review)
* Return orders that are:

  * `status = delivered`
  * `payment_intents.status = settled`
  * NOT yet paid

## **Acceptance Criteria**

* [ ] Endpoint returns only delivered + settled + unpaid orders
* [ ] Endpoint returns only delivered + settled + unpaid order detail (line items totals, discounts agent info etc)
* [ ] Response includes orderId, vendorStoreId, amount, deliveredAt
* [ ] Non-admin access is rejected with 403

## **Dependencies**

* Blocked by: None
* Blocks: PF-XXX

## **Technical Notes**

* Query joins:

  * `vendor_orders`
  * `payment_intents`
* Sorting default: oldest delivered first
* Pagination required (limit + cursor)
* **ASSUMPTION:** no filtering beyond eligibility in MVP

## **Out of Scope**

* Payout approval actions
* Vendor-visible payout views

---

## **Title [PF-XXX]: Admin confirm payout endpoint**

## **Type**

Feature

## **Description**

Allow an admin to confirm that a vendor has been paid. This endpoint finalizes the financial lifecycle of an order by appending a payout ledger event and closing the order.

## **Scope**

* Implement `POST /api/v1/admin/orders/{orderId}/confirm-payout`
* Perform all updates atomically:

  * Append `ledger_events(type=vendor_payout)`
  * Update `payment_intents.status = paid`
  * Set `vendor_paid_at`
  * Set `vendor_orders.status = closed`
  * Emit outbox event `order_paid`

## **Acceptance Criteria**

* [ ] Ledger event `vendor_payout` is inserted exactly once
* [ ] Payment intent transitions to `paid`
* [ ] Order transitions to `closed`
* [ ] Outbox event `order_paid` is emitted
* [ ] Endpoint is idempotent

## **Dependencies**

* Blocked by: PF-XXX, PF-XXX, PF-XXX
* Blocks: None

## **Technical Notes**

* Must run inside a DB transaction
* Idempotency enforced via Idempotency-Key
* Repeated calls MUST return the original success response
* **ASSUMPTION:** payout amount equals `payment_intents.amount_cents`

## **Out of Scope**

* Automatic payouts
* ACH integration
* Payout reversals

---

## **Title [PF-XXX]: Vendor “confirm paid” acknowledgment endpoint (audited only)**

## **Type**

Feature

## **Description**

Provide an optional vendor-facing endpoint allowing vendors to acknowledge they have received payment. This is informational only and does not affect financial truth.

## **Scope**

* Implement vendor endpoint to confirm payment receipt
* Record acknowledgment in audit logs
* Do NOT mutate ledger, payment intent, or order state

## **Acceptance Criteria**

* [ ] Vendor can submit a “paid confirmed” action
* [ ] Action is written to `audit_logs`
* [ ] No financial or order state changes occur

## **Dependencies**

* Blocked by: PF-XXX
* Blocks: None

## **Technical Notes**

* Endpoint location: `/api/v1/vendor/orders/{orderId}/confirm-paid`
* Must validate vendor owns the order
* **ASSUMPTION:** acknowledgment payload is minimal (timestamp + optional note)

## **Out of Scope**

* Dispute handling
* Financial reconciliation logic
