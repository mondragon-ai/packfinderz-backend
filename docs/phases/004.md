[DONE ✅]
## Title [PF-044]: License model + migration (media_id required)

## Type

Feature

## Description

Introduce the canonical `licenses` data model with a **required `media_id`** at creation time. Licenses are the source of truth for compliance and MUST always reference an uploaded media object (PDF/image) representing the license document.

This enforces the corrected compliance rule: **license metadata cannot exist without media**.

## Scope

* Create `licenses` table via Goose migration
* `media_id` is **NOT NULL**
* Enforce FK relationship to `media`
* Add required indexes for compliance workflows

## Acceptance Criteria

* [ ] `licenses.media_id` is `NOT NULL`
* [ ] Migration is reversible or forward-safe
* [ ] FK to `media(id)` enforced
* [ ] Indexes exist for `(store_id, status)` and `expiration_date`
* [ ] Migration runs cleanly in dev and prod modes
* [ ] Get the media metadata and validate the mime type is acceptable (PDF or Image)

* [ ] Goose migration creates `licenses` table with:

  * `id` (uuid, pk)
  * `store_id` (uuid, not null)
  * `user_id` (uuid, not null)
  * `status` (`license_status` enum)
  * `media_id` (uuid, not null) 
  * `created_at` (timestamptz)
  * `issuing_state` (text, not null) 
  * `issue_date`  (timestamptz)
  * `expiration_date`  (timestamptz)
  * `type` (`license_type` enum)
  * `number` (text, not null, unique) 

* [ ] Canonical `license_status` enum includes: `pending`, `verified`, `rejected`, `expired`
* [ ] Canonical `license_type` enum includes: `producer`, `grower`, `dispensary`, `merchant` (can be added later on)
* [ ] GORM models exist for `Licenses` in the DB models folder

## Dependencies

* Blocked by: Media table existing
* Blocks: PF-045, PF-047, PF-051

## Technical Notes

* Table: `licenses`
* Enum: `license_status`
* FK: `media_id → media(id)`
* **ASSUMPTION:** One license = one media document (no multi-doc license)

## Out of Scope

* Admin approval logic
* Background schedulers

---
[DONE ✅]
## Title [PF-045]: License create endpoint (atomic metadata + media_id)

## Type

Feature

## Description

Implement the license creation endpoint that **atomically creates license metadata**. Creating a license without a `media_id` reference MUST be impossible.

## Scope

* `POST /api/v1/licenses`
* Validate `media_id` ownership and readiness
* Create license in `pending` state
* Enforce store scoping via `activeStoreId`
* Idempotent behavior

## Acceptance Criteria

* [ ] Request without `media_id` fails validation (`400`)
* [ ] Media must belong to active store
* [ ] License is created with `status=pending`
* [ ] Idempotency enforced via `Idempotency-Key` (see middleware and redis client)
* [ ] Response returns created license object

## Dependencies

* Blocked by: PF-044
* Blocks: PF-048, PF-049

## Technical Notes

* Endpoint: `POST /api/v1/licenses`
* Validation: media must be `uploaded|ready` & accepted media type (image or pdf)
* **ASSUMPTION:** Media is uploaded before license creation (UI flow enforced)

## Out of Scope

* Admin verification
* OCR or data extraction
* Auto validation with scraping or api (state specific).

---

## Title [PF-046]: License list endpoint (store-scoped)

## Type

Feature

## Description

Provide a read-only endpoint to list licenses belonging to the active store. This enables store users to view compliance status and upcoming expirations.

## Scope

* `GET /api/v1/licenses`
* Store-scoped via `activeStoreId`
* Return metadata only (no signed URLs)

## Acceptance Criteria

* [ ] Only licenses for `activeStoreId` are returned
* [ ] Supports pagination
* [ ] Includes status, expiration date, and media_id
* [ ] Unauthorized access is rejected

## Dependencies

* Blocked by: PF-044
* Blocks: UI compliance views

## Technical Notes

* Table: `licenses`
* RBAC: any store member
* **ASSUMPTION:** Sorting by `created_at desc` default

## Out of Scope

* Admin/global listing
* Media previews

---

## Title [PF-047]: License delete endpoint (expired-only semantics)

## Type

Feature

## Description

Implement controlled license deletion. A license may ONLY be deleted if it is **expired**. If the deleted license was the store’s last valid license, the store’s KYC status MUST be downgraded.

## Scope

* `DELETE /api/v1/licenses/{licenseId}`
* Allow deletion only if `status=expired`
* Update store KYC mirror if needed
* Enforce store ownership

## Acceptance Criteria

* [ ] Deleting non-expired license returns `409`
* [ ] Expired license is deleted successfully
* [ ] If no remaining valid licenses → store becomes unverified
* [ ] Media is detached but not auto-deleted

## Dependencies

* Blocked by: PF-044
* Blocks: PF-050

## Technical Notes

* Table: `licenses`, `stores`
* **ASSUMPTION:** Media GC handled separately
* Store KYC update may be synchronous or event-driven

## Out of Scope

* Admin override delete
* Bulk deletion

---

## Title [PF-048]: License verification script (CLI)

## Type

Task

## Description

Create a **CLI script** that allows an operator to verify or reject a license by ID. This is the primary admin mechanism before the UI is implemented.

## Scope

* Script accepts `store_id`, `license_id`, `status`
* Updates license status
* Writes audit metadata
* Emits outbox event

## Acceptance Criteria

* [ ] Script updates license to `verified` or `rejected`
* [ ] Invalid transitions are rejected
* [ ] Outbox event is written
* [ ] Script is idempotent

## Dependencies

* Blocked by: PF-045
* Blocks: PF-049

## Technical Notes

* Location: `cmd/tools/license_verify`
* **ASSUMPTION:** Script executed by trusted operator

## Out of Scope

* UI
* Notifications

---

## Title [PF-048a]: Admin license verify / reject endpoint

## Type

Feature

## Description

Expose an admin-only HTTP endpoint to verify or reject licenses. This mirrors the CLI behavior but is callable via API for future admin UI.

## Scope

* `POST /api/v1/admin/licenses/{licenseId}/verify`
* Admin-only RBAC
* Idempotent
* Emits outbox event

## Acceptance Criteria

* [ ] Only admins can call endpoint
* [ ] License status updated correctly
* [ ] Idempotency enforced
* [ ] Outbox event written

## Dependencies

* Blocked by: PF-045
* Blocks: PF-049

## Technical Notes

* Uses same service logic as PF-048
* **ASSUMPTION:** No UI yet; endpoint is API-only

## Out of Scope

* Admin dashboards

---

## Title [PF-049]: Emit license status change outbox events

## Type

Task

## Description

Standardize emission of outbox events whenever a license status changes, regardless of whether the change originates from CLI or admin API.

## Scope

* Emit `license_status_changed` events
* Include license_id, store_id, new status
* Used by schedulers and notifications

## Acceptance Criteria

* [ ] Event written for verify/reject
* [ ] Event written for expiry/grace transitions
* [ ] Payload schema consistent
* [ ] Idempotent-safe emission

## Dependencies

* Blocked by: PF-048, PF-048a
* Blocks: PF-050, PF-052

## Technical Notes

* Table: `outbox_events`
* Aggregate: `license`
* **ASSUMPTION:** Consumers are idempotent

## Out of Scope

* Publishing to Pub/Sub (handled by worker)

---

## Title [PF-050]: Mirror license status → store KYC status

## Type

Task

## Description

Implement background logic that mirrors license state changes into the store’s `kyc_status`. Licenses are the source of truth; store KYC is a derived mirror.

## Scope

* Worker consumes `license_status_changed`
* Updates `stores.kyc_status`
* Handles multiple licenses per store

## Acceptance Criteria

* [ ] Store becomes `verified` if ≥1 license verified
* [ ] Store becomes `unverified` if no valid licenses
* [ ] Updates are idempotent
* [ ] No direct API writes to store KYC elsewhere

## Dependencies

* Blocked by: PF-049
* Blocks: Search visibility gating

## Technical Notes

* Worker-side consumer
* **ASSUMPTION:** “verified” means at least one verified, unexpired license

## Out of Scope

* Manual admin overrides

---

## Title [PF-051]: License expiry scheduler (14d warn, expire, revoke)

## Type

Task

## Description

Create a background scheduler that identifies licenses expiring soon, expiring today, and those past grace period. This ticket only builds the **scheduler binary and query logic**.

## Scope

* Daily scheduler binary
* Queries:

  * expiring in ≤14 days
  * expired today
  * expired + 7d grace exceeded
* No notifications yet (PF-052)

## Acceptance Criteria

* [ ] Scheduler binary exists and runs
* [ ] Queries return correct license sets
* [ ] No state mutation yet (emit events only)
* [ ] Safe to re-run (idempotent)

## Dependencies

* Blocked by: PF-044
* Blocks: PF-052

## Technical Notes

* Worker scheduler
* **ASSUMPTION:** Scheduler emits events, does not mutate directly

## Out of Scope

* Notifications
* Store updates

---

## Title [PF-052]: Compliance notifications via outbox events

## Type

Task

## Description

Emit compliance-related outbox events for stores when licenses approach expiration, expire, or exceed grace period. These events drive notifications and KYC revocation.

## Scope

* Emit events for:

  * 14-day warning
  * expiration date
  * post-7-day grace expiration
* Store-scoped events

## Acceptance Criteria

* [ ] Correct event emitted per condition
* [ ] Events include store_id and license_id
* [ ] No duplicate events for same window
* [ ] Grace period enforced correctly

## Dependencies

* Blocked by: PF-051, PF-049
* Blocks: Notification workers

## Technical Notes

* Event types: `license_expiring`, `license_expired`, `license_grace_exceeded`
* **ASSUMPTION:** Grace period = 7 days after expiration_date

## Out of Scope

* Delivery of notifications (email/SMS/UI)
