#  Title [PF-243]: Transition fulfilled orders to ready-for-dispatch and emit dispatch outbox event

## Type

Feature

## Description

When all line items in an order are no longer pending, transition the order into a dispatch-ready state and emit a single outbox event signaling readiness for dispatch. This event is consumed by both admin and agent workflows.

## Scope

* Detect when an order becomes fully non-pending (each line item frm the item has been individually fulfilled or rejected via `POST api/v1/vendor/orders/{orderId}/line-items/decision`)
* Transition order state to `ready_for_dispatch` (or equivalent)
* Emit outbox event `order_ready_for_dispatch`
* Ensure event is emitted exactly once per order

**NOT included**

* Agent assignment
* Cash collection
* Notifications or UI updates

## Acceptance Criteria

* [ ] Order transitions to dispatch-ready state only when all line items are non-pending
* [ ] `order_ready_for_dispatch` outbox event is written exactly once
* [ ] Event includes order ID, buyer store ID, vendor store ID(s)
* [ ] Replaying fulfillment requests does not emit duplicate dispatch events

## Dependencies

* Blocked by: PF-242
* Blocks: PF-244 (agent cash collection flow)

## Technical Notes

* Services: `orders`, `outbox`
* Tables: `orders`, `outbox_events`
* Event type: `order_ready_for_dispatch`
* **ASSUMPTION:** Outbox worker already exists and reliably publishes events

## Out of Scope

* Agent routing logic
* Delivery tracking
* UI consumption of dispatch events

---

# Title [PF-244]: Implement agent cash-collected endpoint and append ledger cash_collected event

## Type

Feature

## Description

Implement the agent-facing endpoint that records when cash has been collected for an order. This endpoint must append a `ledger_events(cash_collected)` record to ensure financial auditability.

## Scope

* Implement `POST /api/v1/agent/orders/{orderId}/cash-collected`
* Validate agent authorization
* Append ledger event `cash_collected`
* Prevent duplicate cash collection entries

**NOT included**

* Settlement logic
* Vendor payouts
* Accounting exports

## Acceptance Criteria

* [x] Agent can mark an order as cash collected
* [x] `ledger_events` record with type `cash_collected` is appended
* [x] Endpoint is idempotent (duplicate calls do not create multiple ledger rows)
* [x] Unauthorized agents are rejected

## Dependencies

* Blocked by: PF-243
* Blocks: PF-245 (payment intent settlement + order state updates)

## Technical Notes

* Services: `orders`, `ledger`, `agents`
* Tables: `ledger_events`, `orders`
* API: `POST /agent/orders/{orderId}/cash-collected`
* **ASSUMPTION:** LedgerEvent is append-only and immutable

## Out of Scope

* Vendor payout calculations
* Refunds or adjustments
* Admin overrides

---

# [INCOMPLETE ❌] Title [PF-245]: Set payment intent settled state and emit cash_collected outbox event

## Type

Feature

## Description

Finalize the cash collection flow by marking the payment intent as settled, recording the cash collection timestamp, updating order states, and emitting a `cash_collected` outbox event for downstream consumers.

## Scope

* Set `payment_intents.status = settled`
* Set `cash_collected_at` timestamp
* Update order payment and fulfillment states
* Emit outbox event `cash_collected`

**NOT included**

* Vendor payout execution
* Reconciliation jobs
* External accounting integrations

## Acceptance Criteria

* [ ] Payment intent transitions to `settled`
* [ ] `cash_collected_at` is populated exactly once
* [ ] Order state reflects completed cash collection
* [ ] `cash_collected` outbox event is emitted exactly once
* [ ] Flow is idempotent

## Dependencies

* Blocked by: PF-244
* Blocks: None (end of Phase 7)

## Technical Notes

* Services: `payments`, `orders`, `outbox`
* Tables: `payment_intents`, `orders`, `outbox_events`
* Event type: `cash_collected`
* **ASSUMPTION:** PaymentIntent model already exists and is linked to Order

## Out of Scope

* ACH or non-cash payment flows
* Vendor payout distribution
* Reporting or analytics aggregation

Below are **failure-path Jira tickets**, starting at **PF-246**, fully formed, one at a time, strictly within **Phase 7** and aligned with your existing `PaymentStatus` enum. No new payment methods are introduced; ACH-related states are **future-aware only**.

---

# [INCOMPLETE ❌] Title [PF-2XX]: Reject cash collection when order is not dispatch-ready & create endpoint (`POST /agent/orders/{orderId}/cash-collected`)

## Type

Bug

## Description

Prevent agents from marking cash as collected on orders that are not yet eligible for cash collection. Cash collection MUST only be allowed once an order has reached the dispatch-ready (or equivalent) state after fulfillment. THat said, create the agent end point (scoepd by agent role + JWT). Agent 

This protects against premature settlement and ledger corruption.

## Scope

* Validate order state before allowing cash collection
* Reject cash collection attempts for non-dispatch-ready orders
* Return a clear error response

**NOT included**

* Order state transitions
* Fulfillment logic changes

## Acceptance Criteria

* [ ] Agent cash-collected endpoint returns `400` or `409` when order is not dispatch-ready
* [ ] No `ledger_events` are appended on invalid attempts
* [ ] No payment or order state is mutated
* [ ] Error response clearly indicates invalid order state
* [ ] If eligable, agent will be able to mark the order as cash collected passing the dollar amount received. 
* [ ] Adjust the `payment_intent` & `order_assignment` table with relevant fields as well as the status of the `vendor_orders`

## Dependencies

* Blocked by: PF-243
* Blocks: None

## Technical Notes

* Services: `vendor_orders`, `agents`
* Tables: `vendor_orders`, `order_assignment`, `payment_intent`
* API: `POST /agent/orders/{orderId}/cash-collected`
* **ASSUMPTION:** There is a canonical order state representing “ready for cash collection”

## Out of Scope

* Admin overrides
* Partial cash handling

---

# [INCOMPLETE ❌] Title [PF-2XX]: Prevent duplicate cash collection on already settled or paid orders

## Type

Bug

## Description

Ensure that cash collection cannot be recorded more than once for the same order. If an order’s payment intent is already in a terminal state (`settled`, `paid`, `failed`, or `rejected`), the system must reject further cash collection attempts.

## Scope

* Guard against duplicate cash collection
* Enforce terminal payment status immutability
* Return idempotent or rejection responses appropriately

**NOT included**

* Refund handling
* Ledger reversal logic

## Acceptance Criteria

* [ ] Cash collection on `settled` or `paid` orders is rejected
* [ ] Cash collection on `failed` or `rejected` orders is rejected
* [ ] No additional ledger events are created
* [ ] Response indicates order is already finalized

## Dependencies

* Blocked by: PF-244
* Blocks: None

## Technical Notes

* Services: `payments`, `orders`, `ledger`
* Tables: `payment_intents`, `ledger_events`
* **ASSUMPTION:** Payment intent is the source of truth for payment finality

## Out of Scope

* Manual admin correction
* Retroactive payment changes

---

# [INCOMPLETE ❌] Title [PF-2XX]: Mark payment intent as failed when cash collection validation fails

## Type

Feature

## Description

When a cash collection attempt fails due to validation or processing errors (e.g., mismatch in expected amount, order inconsistency), the payment intent should be transitioned to `failed` to prevent repeated attempts without admin intervention. This will return the order back to the vendor ad ajdust the order states as needed. 

This provides a controlled failure state even for cash-based flows.

## Scope

* Transition `payment_intents.status` to `failed` on terminal cash-collection errors
* Persist failure reason
* Prevent further cash collection attempts

**NOT included**

* Retry mechanisms
* Automated recovery

## Acceptance Criteria

* [ ] Payment intent transitions to `failed` on unrecoverable cash collection errors
* [ ] Failure reason is persisted
* [ ] Subsequent cash collection attempts are rejected
* [ ] No `cash_collected` ledger event is emitted
* [ ] Order needs to roll back to `refunded` or ``returned` and all relevant status and tables should be updated for the order.

## Dependencies

* Blocked by: PF-244
* Blocks: PF-250 (admin resolution flow)

## Technical Notes

* Services: `payments`, `orders`
* Tables: `payment_intents`
* **ASSUMPTION:** Failure reasons can be stored as free-form text or enum

## Out of Scope

* Automated retries
* Vendor notifications

---

# [INCOMPLETE ❌] Title [PF-2XX]: Support rejected payment state for future ACH or admin-declined settlements

## Type

Chore

## Description

Introduce explicit handling for `PaymentStatusRejected` to represent payments that are intentionally declined (e.g., future ACH rejection, admin decision). This ticket does not implement ACH but ensures the system cleanly supports the state.

## Scope

* Allow payment intent to transition to `rejected`
* Prevent further settlement actions on rejected payments
* Ensure order reflects rejected payment state

**NOT included**

* ACH initiation
* ACH processing logic
* Retry flows

## Acceptance Criteria

* [ ] Payment intent can be set to `rejected`
* [ ] Rejected payment blocks settlement and cash collection
* [ ] Order state reflects rejection
* [ ] No ledger `cash_collected` event is emitted

## Dependencies

* Blocked by: PF-245
* Blocks: None

## Technical Notes

* Services: `payments`, `orders`
* Tables: `payment_intents`
* **ASSUMPTION:** Rejection is a terminal state requiring admin intervention

## Out of Scope

* ACH rails
* Dispute resolution
* Notifications

---

# [INCOMPLETE ❌] Title [PF-2XX]: Emit payment_failed or payment_rejected outbox events for downstream consumers

## Type

Feature

## Description

Emit explicit outbox events when a payment intent enters `failed` or `rejected` states so downstream systems (admin dashboards, alerts/notifciations, reconciliation) can respond appropriately.

## Scope

* Emit `payment_failed` event
* Emit `payment_rejected` event
* Ensure events are emitted exactly once per transition

**NOT included**

* Event consumers
* Notification delivery

## Acceptance Criteria

* [ ] `payment_failed` outbox event emitted on transition to `failed`
* [ ] `payment_rejected` outbox event emitted on transition to `rejected`
* [ ] Events include order ID and payment intent ID
* [ ] Duplicate transitions do not emit duplicate events

## Dependencies

* Blocked by: PF-248, PF-249
* Blocks: None

## Technical Notes

* Services: `payments`, `outbox`
* Tables: `outbox_events`, `payment_intents`
* **ASSUMPTION:** Outbox publisher already handles new event types

## Out of Scope

* Alerting rules
* UI reactions
