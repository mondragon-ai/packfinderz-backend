## **Title [PF-113]: Stripe client bootstrap, config, and secrets management**

## **Type**

Infra

## **Description**

Bootstrap Stripe integration by adding a reusable Stripe client with secure configuration and secrets management. This enables subscription creation, cancellation, billing queries, and webhook verification.

## **Scope**

* Add Stripe client wrapper
* Load Stripe API keys via secrets/config
* Support test and live environments
* Expose client to API and worker layers

## **Acceptance Criteria**

* [ ] Stripe client initializes successfully in API and worker
* [ ] Missing or invalid secrets fail fast at startup
* [ ] Environment switching (test/live) is configurable

## **Dependencies**

* Blocked by: Stripe account + API keys provisioned
* Blocks: PF-XXX, PF-XXX, PF-XXX

## **Technical Notes**

* Location: `pkg/stripe`
* Secrets:

  * `PACKFINDERZ_STRIPE_API_KEY`
  * `PACKFINDERZ_STRIPE_SECRET`
* **ASSUMPTION:** secrets are injected via env vars (no Vault in MVP)

## **Out of Scope**

* Multi-account Stripe support
* Manual key rotation tooling

---

## **Title [PF-114]: Subscription and billing data model migrations**

## **Type**

Infra

## **Description**

Create or verify all database tables required for Stripe-based subscriptions and billing history. These tables persist Stripe state locally and act as the source of truth for gating and reporting.

## **Scope**

* Migrations for:

  * `subscriptions`
  * `payment_methods` // Probaby should hash the PM from stripe while in storage -- similar to the password, right? 
  * `charges` -> platform charges (subs + later on order charges + later on advanced analytics synthesis)
  * `usage_charges` (if not already present) -> ads
* Corresponding models, enums, repos, and services

## **Acceptance Criteria**

* [ ] All tables exist with correct fields and indexes
* [ ] FK relationships enforce store ownership
* [ ] Models and repos compile and are usable by services

## **Dependencies**

* Blocked by: None
* Blocks: PF-XXX, PF-XXX, PF-XXX

## **Technical Notes**

* Key fields (subscriptions):

  * `id`
  * `store_id`
  * `stripe_subscription_id`
  * `status`
  * `current_period_end`
* **ASSUMPTION:** one active subscription per vendor store (1 â†’ 0/1)

## **Out of Scope**

* Subscription plan management UI
* Historical plan migrations

---

## **Title [PF-115]: Vendor subscription lifecycle endpoints (create, cancel, fetch)**

## **Type**

Feature

## **Description**

Implement vendor-facing subscription endpoints to create, cancel, and fetch the current subscription. All operations must be idempotent and enforce a one-to-one relationship between vendor store and active subscription.

## **Scope**

* `POST /api/v1/vendor/subscriptions` (create)
* `POST /api/v1/vendor/subscriptions/cancel`
* `GET /api/v1/vendor/subscriptions` (return single active or null)
* Stripe + DB state kept in sync

## **Acceptance Criteria**

* [ ] Subscription creation is idempotent
* [ ] Cancellation is idempotent and safe to retry
* [ ] Fetch returns at most one active subscription
* [ ] Non-vendor access is rejected

## **Dependencies**

* Blocked by: PF-XXX, PF-XXX
* Blocks: PF-XXX, PF-XXX

## **Technical Notes**

* Controller: `api/controllers/subscriptions/vendor`
* Idempotency via Idempotency-Key
* **ASSUMPTION:** pricing/plan IDs are fixed in config for MVP

## **Out of Scope**

* Subscription upgrades/downgrades
* Proration previews

---

## **Title [PF-XXX]: Stripe webhook consumer for subscription state sync**

## **Type**

Feature

## **Description**

Add a Stripe webhook endpoint to consume subscription lifecycle events and mirror Stripe truth into local tables. This endpoint is authoritative for subscription state changes.

## **Scope**

* Webhook endpoint (e.g. `/api/v1/webhooks/stripe`)
* Handle relevant events:

  * `customer.subscription.created`
  * `customer.subscription.updated`
  * `customer.subscription.deleted`
  * `invoice.paid`
  * `invoice.payment_failed`
* Update:

  * `subscriptions.status`
  * `stores.subscription_active`

## **Acceptance Criteria**

* [ ] Webhook signatures are verified
* [ ] Subscription state updates correctly on Stripe events
* [ ] `stores.subscription_active` mirrors Stripe truth
* [ ] Duplicate webhook deliveries are idempotent

## **Dependencies**

* Blocked by: PF-XXX, PF-XXX
* Blocks: PF-XXX

## **Technical Notes**

* Idempotency key: Stripe `event.id`
* Processing MAY occur inline or via worker
* **ASSUMPTION:** webhook endpoint is publicly reachable (no queue fan-out in MVP)

## **Out of Scope**

* Webhook replay tooling
* Non-subscription Stripe events

---

## **Title [PF-XXX]: Vendor billing history endpoint (charges)**

## **Type**

Feature

## **Description**

Expose a vendor-facing endpoint to list billing charges related to subscriptions and ads. This provides transparency and basic billing history.

## **Scope**

* Implement `GET /api/v1/vendor/billing/charges`
* Return charges from:

  * subscription invoices
  * ad/usage charges (if present)
* Pagination support

## **Acceptance Criteria**

* [ ] Endpoint returns charges scoped to vendor store
* [ ] Includes amount, type, status, created_at
* [ ] Results are consistent with Stripe/local records

## **Dependencies**

* Blocked by: PF-XXX, PF-XXX
* Blocks: None

## **Technical Notes**

* Controller: `api/controllers/billing/vendor`
* Data source: local `charges` table (mirrored from Stripe)
* **ASSUMPTION:** no PDF invoices returned in MVP

## **Out of Scope**

* Refund initiation
* Detailed invoice line items

---

## **Title [PF-XXX]: Enforce subscription gating across marketplace**

## **Type**

Task

## **Description**

Verify and enforce that vendor listings are hidden or excluded when `stores.subscription_active=false`. This ensures unpaid vendors cannot appear in browse/search results.

## **Scope**

* Audit browse/search query paths
* Enforce subscription gating at query or service layer
* Add tests to prevent regressions

## **Acceptance Criteria**

* [ ] Vendors without active subscriptions do not appear in browse/search
* [ ] Active vendors remain unaffected
* [ ] No performance regressions introduced

## **Dependencies**

* Blocked by: PF-XXX, PF-XXX
* Blocks: None

## **Technical Notes**

* Likely enforced in product/search service
* **ASSUMPTION:** partial gating already exists; task verifies and hardens it

## **Out of Scope**

* Admin overrides
* Grace periods or trial logic
