# Title [PF-209]: Implement buyer/vendor product list endpoint with filters and pagination

## Type

Feature

## Description

Implement a paginated product list endpoint used by buyer and vendor product grid views. This endpoint returns a summarized product representation and supports multiple filters to power browse/search experiences.

## Scope

* Implement `GET /v1/products`
* Pagination (cursor or offset-based, consistent with existing patterns)
* Product summary projection (no heavy joins)
* Filtering:

  * category (e.g. `flower`, `pre_roll`, `vape`, etc)
  * THC/CBD range
  * price range
  * classification (e.g. `sativa`, `hybrid`)
  * has promo (volume discount `VolumeDiscounts` is empty or not)
* Buyer-visible constraints (only active, compliant products)

**Explicitly NOT included**

* Full product detail payload
* Inventory mutations
* Sorting beyond default relevance/order

## Acceptance Criteria

* [ ] Endpoint returns paginated product summaries
* [ ] All documented filters work independently and in combination
* [ ] Buyer users only see eligible products
* [ ] Vendor users see only their store’s products

## Dependencies

* Blocked by: Product + inventory models existing
* Blocks: PF-211

## Technical Notes

* Controller: products browse controller
* Repo-level filtering (no in-memory filtering)
* **ASSUMPTION:** default sort is newest or relevance-based

## Out of Scope

* Elasticsearch integration
* Advanced ranking algorithms

---

# Title [PF-210]: Implement vendor-only product table endpoint with filters and pagination

## Type

Feature

## Description

Implement a vendor-only product list endpoint for the internal product table UI. This endpoint exposes vendor-owned products only and includes operational metadata needed for management.

## Scope

* Implement `GET /v1/vendor/products`
* Pagination support
* Product summary suitable for table view
* Same filter set as PF-209:

  * category (e.g. `flower`, `pre_roll`, `vape`, etc)
  * THC/CBD range
  * price range
  * classification (e.g. `sativa`, `hybrid`)
  * has promo (volume discount `VolumeDiscounts` is empty or not)
  * text search (`q`)
* Vendor-only access enforcement

  * This is exactly the same as `GET /v1/products` hwoever fetch only products associated with the `activeStoreId` from the claims

**Explicitly NOT included**

* Buyer visibility rules
* Full product detail
* Inventory updates

## Acceptance Criteria

* [ ] Endpoint is accessible only to vendor users
* [ ] Returns only products owned by the active vendor store
* [ ] Filters and pagination behave consistently
* [ ] Response shape matches table UI needs

## Dependencies

* Blocked by: Product model completeness
* Blocks: PF-211

## Technical Notes

* Controller: vendor products controller
* **ASSUMPTION:** vendor-only endpoint may include inactive products

## Out of Scope

* Admin/global product views
* Bulk actions

---

# [INCPMPLETE ❌] Title [PF-211]: Add VendorSummary to product browse and detail responses

## Type

Feature

## Description

Augment product browse and detail responses with a lightweight VendorSummary object to support UI display of vendor context.

## Scope

* Join product → store
* Include VendorSummary fields:

  * store id
  * store name
  * optional logo attachment
* Add to both product list and product detail responses

**Explicitly NOT included**

* Full store profile data
* Store analytics

## Acceptance Criteria

* [ ] Product responses include VendorSummary
* [ ] Logo attachment is included when present
* [ ] Missing logo does not break response

## Dependencies

* Blocked by: PF-209, PF-210
* Blocks: None

## Technical Notes

* Join via stores table
* Logo resolved via media attachments
* **ASSUMPTION:** VendorSummary is read-only and cached per response

## Out of Scope

* Store banner or ratings
* Vendor permissions

---

# [INCPMPLETE ❌] Title [PF-212]: Add low stock threshold and max quantity constraints

## Type

Feature

## Description

Extend inventory and product models with additional constraints to support better stock management and ordering limits.

## Scope

* Add `low_stock_threshold` to inventory:

  * DB migration
  * model update
  * DTO updates
* Add `max_qty` to product:

  * DB migration
  * model update
  * DTO updates
  * validation rules

**Explicitly NOT included**

* Notification triggers
* Auto-restock logic

## Acceptance Criteria

* [ ] Inventory supports configurable low stock threshold
* [ ] Product enforces max quantity per order
* [ ] Invalid values fail validation

## Dependencies

* Blocked by: Inventory and product models
* Blocks: PF-216

## Technical Notes

* Validation should occur at service layer
* **ASSUMPTION:** `max_qty` applies per line item, not per order

## Out of Scope

* UI warnings
* Automatic alerts

---

# [INCPMPLETE ❌] Title [PF-213]: Convert volume discount to percentage-based pricing

## Type

Feature

## Description

Change volume discount logic to use percentage-based discounts derived from `unit_price_cents` instead of fixed dollar amounts. This ensures consistent discount behavior across cart and checkout flows.

## Scope

* Update volume discount model to percentage value
* Update all pricing calculations:

  * cart
  * checkout
  * order totals
* Migrate or adapt existing discount data if present

**Explicitly NOT included**

* Tiered discount redesign
* Promotions engine

## Acceptance Criteria

* [ ] Volume discounts apply as percentage off unit price
* [ ] Cart and checkout totals reflect correct discounts
* [ ] No fixed-amount discounts remain in use

## Dependencies

* Blocked by: Existing volume discount implementation
* Blocks: None

## Technical Notes

* Percentage stored as integer or decimal per convention
* **ASSUMPTION:** existing data can be migrated or reset safely

## Out of Scope

* UI copy changes
* Advanced promotions

---

# [INCPMPLETE ❌] Title [PF-214]: Add media_id to product media model

## Type

Task

## Description

Extend the product media model to include a direct `media_id` reference, enabling stronger linkage with the media system and attachment lifecycle.

## Scope

* DB migration to add `media_id`
* Update product media model
* Update DTOs and validations
* Ensure compatibility with media attachment system

**Explicitly NOT included**

* Media attachment sync logic
* Backfilling existing records

## Acceptance Criteria

* [ ] Product media rows store `media_id`
* [ ] Validations ensure referenced media exists
* [ ] API accepts and returns `media_id`

## Dependencies

* Blocked by: Media model stability
* Blocks: PF-216

## Technical Notes

* FK optional or enforced per design
* **ASSUMPTION:** product media references a single media object

## Out of Scope

* Media reuse rules
* Deletion behavior

---

# [INCPMPLETE ❌] Title [PF-215]: Implement audit action schema and helper for product and inventory

## Type

Task

## Description

Introduce a standardized audit action schema and helper utilities to record product and inventory changes for traceability.

## Scope

* Define audit action schema
* Create helper for emitting audit rows
* Support product and inventory domains

**Explicitly NOT included**

* UI for audit logs
* Cross-domain auditing

## Acceptance Criteria

* [ ] Audit schema is defined and documented
* [ ] Helper can emit audit rows consistently
* [ ] Audit rows include actor, action, timestamp

## Dependencies

* Blocked by: Audit table or logging mechanism
* Blocks: PF-216

## Technical Notes

* Likely stored in audit_log table
* **ASSUMPTION:** audit rows are append-only

## Out of Scope

* Query APIs for audits
* Retention policies

---

# [INCPMPLETE ❌] Title [PF-216]: Emit audit records on product and inventory mutations

## Type

Feature

## Description

Emit audit records for all product and inventory mutations to ensure traceability of vendor actions.

## Scope

* Emit audit rows on:

  * product create
  * product update
  * product delete
  * inventory set/update
* Use shared audit helper

**Explicitly NOT included**

* Audit record querying
* Admin review tooling

## Acceptance Criteria

* [ ] All listed actions generate audit records
* [ ] Audit records include correct metadata
* [ ] No duplicate or missing audit entries

## Dependencies

* Blocked by: PF-215
* Blocks: None

## Technical Notes

* Emit within same transaction as mutation
* **ASSUMPTION:** audit failures fail the parent transaction

## Out of Scope

* Notifications
* Compliance exports
