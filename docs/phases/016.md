
## Title [PF-129]: Create/finalize `media_attachments` table and indexes

## Type

Infra

## Description

Introduce/update a canonical `media_attachments` table to normalize how media is linked to domain entities. This table represents **usage**, not ownership, and is required to support safe deletion and multi-entity reuse of media.

## Scope

* Create `media_attachments` table
* Add indexes for entity-based and media-based lookups
* Enforce store scoping via FK or explicit column

**NOT included**

* Domain wiring
* Media deletion logic
* Backfilling existing media relationships

## Acceptance Criteria

* [ ] `media_attachments` table exists with correct columns
* [ ] Index exists for `(entity_type, entity_id)`
* [ ] Index exists for `(media_id)`
* [ ] Table supports multiple rows per `media_id`

## Dependencies

* Blocked by: Existing `media` table
* Blocks: PF-1402, PF-1403, PF-1404, PF-1405, PF-1406, PF-1407

## Technical Notes

* Fields:

  * `id (uuid, pk)`
  * `media_id (uuid, fk â†’ media.id)`
  * `entity_type (enum/text)`
  * `entity_id (uuid)`
  * `store_id (uuid)`
  * `gcs_key (text)`
  * `created_at (timestamptz)`
* FK on `media_id` MUST be `ON DELETE RESTRICT`
* **ASSUMPTION:** `entity_type` is a controlled enum in code, not DB enum (MVP)

## Out of Scope

* Polymorphic ORM helpers
* Cascading deletes

---

# Jira Ticket

## Title [PF-1402]: Define media attachment lifecycle and deletion rules

## Type

Chore

## Description

Document and codify the lifecycle rules governing media attachments, including constraints around deletion and protected usage. This serves as the authoritative reference for all domain integrations.

## Scope

* Add code comments near attachment models
* Add markdown documentation describing lifecycle rules
* Explicitly define protected attachment types

**NOT included**

* Runtime enforcement
* UI validation

## Acceptance Criteria

* [ ] Lifecycle rules are documented in-code and in docs
* [ ] Rules clearly define protected vs unprotected attachments
* [ ] Deletion preconditions are unambiguous

## Dependencies

* Blocked by: PF-1401
* Blocks: PF-1403, PF-1404, PF-1405, PF-1406, PF-1407

## Technical Notes

* Explicit rules:

  * One attachment row per usage
  * Media delete allowed only if:

    * zero attachments exist, OR
    * attachments are non-protected
  * License attachments are **always protected**
* **ASSUMPTION:** protection is enforced in service layer, not DB

## Out of Scope

* Automated rule validation
* Migration of legacy behavior

---

# Jira Ticket

## Title [PF-1403]: Wire license media via `media_attachments`

## Type

Feature

## Description

Integrate licenses with the canonical attachment model so license documents (e.g. PDFs) are linked via `media_attachments` and marked as protected usage.

## Scope

* Create attachment row when license is created
* Mark attachment as protected
* Update license queries to resolve media via attachments

**NOT included**

* License approval logic
* Media deletion endpoints

## Acceptance Criteria

* [ ] License creation creates exactly one attachment row
* [ ] Attachment is marked as protected
* [ ] License media resolves via attachments, not direct FK

## Dependencies

* Blocked by: PF-1401, PF-1402
* Blocks: None

## Technical Notes

* Entity type: `license`
* Service: `internal/licenses`
* **ASSUMPTION:** one media file per license

## Out of Scope

* Multiple license documents
* License media replacement

---

# Jira Ticket

## Title [PF-1404]: Wire product media via `media_attachments` (gallery + COA)

## Type

Feature

## Description

Refactor product media usage to rely on `media_attachments` for both gallery images/videos and COA documents. This enables safe reuse and deletion.

## Scope

* Attach gallery media via attachments
* Attach COA media via attachments
* Resolve product media through attachment queries

**NOT included**

* Product CRUD changes
* Media upload pipeline changes

## Acceptance Criteria

* [ ] Gallery media produces one attachment per media item
* [ ] COA media attachment is marked protected
* [ ] Product reads no longer rely on direct media IDs

## Dependencies

* Blocked by: PF-1401, PF-1402
* Blocks: None

## Technical Notes

* Entity type: `product`
* COA attachments MUST be protected
* **ASSUMPTION:** gallery media is non-protected

## Out of Scope

* Product media ordering
* Gallery limits

---

# Jira Ticket

## Title [PF-1405]: Wire store media via `media_attachments` (logo + banner)

## Type

Feature

## Description

Integrate store branding media (logo and banner) using the canonical attachment model to standardize media usage and allow safe replacement.

## Scope

* Attach logo media via attachments
* Attach banner media via attachments
* Resolve store branding media via attachments

**NOT included**

* Store profile UI changes
* Media upload flows

## Acceptance Criteria

* [ ] Logo attachment is created on update
* [ ] Banner attachment is created on update
* [ ] Old attachments remain until explicitly deleted

## Dependencies

* Blocked by: PF-1401, PF-1402
* Blocks: None

## Technical Notes

* Entity type: `store`
* Store branding attachments are non-protected
* **ASSUMPTION:** only one active logo and banner are queried

## Out of Scope

* Automatic cleanup of old branding media
* Version history

---

# Jira Ticket

## Title [PF-1406]: Wire user avatar media via `media_attachments`

## Type

Feature

## Description

Attach user avatar images using the canonical attachment model to unify user media handling and deletion semantics.

## Scope

* Create attachment on avatar update
* Resolve avatar media via attachments
* Enforce store scoping

**NOT included**

* User profile editing UI
* Avatar cropping or resizing

## Acceptance Criteria

* [ ] Avatar update creates attachment row
* [ ] User avatar resolves via attachments
* [ ] Attachment is non-protected

## Dependencies

* Blocked by: PF-1401, PF-1402
* Blocks: None

## Technical Notes

* Entity type: `user`
* **ASSUMPTION:** avatars are per-user, not per-store

## Out of Scope

* Multiple avatars
* Avatar history cleanup

---

# Jira Ticket

## Title [PF-1407]: Wire ad creative media via `media_attachments`

## Type

Feature

## Description

Integrate ad creatives with the canonical attachment model to ensure ads reference media via normalized attachments and can participate in safe deletion checks.

## Scope

* Attach ad media via attachments
* Resolve ad creative media via attachments
* Ensure ads tolerate media reuse across campaigns

**NOT included**

* Ad serving logic
* Ad analytics

## Acceptance Criteria

* [ ] Ad creation creates attachment rows
* [ ] Ads resolve creative media via attachments
* [ ] Ad media attachments are non-protected

## Dependencies

* Blocked by: PF-1401, PF-1402
* Blocks: None

## Technical Notes

* Entity type: `ad`
* **ASSUMPTION:** ads may reuse the same media across campaigns

## Out of Scope

* Creative versioning
* A/B testing support
