# Title [PF-252]: Wire product ↔ media attachments (gallery + COA) using canonical reconciler

## Type

Feature

## Description

Wire product media references (gallery images and COA documents) to the canonical `media_attachments` lifecycle. Any product create or update that modifies media references MUST reconcile attachments using the shared attachment reconciler and perform all attachment mutations within the same database transaction as the product write.

This ensures product media usage is tracked correctly and remains consistent with deletion and protection rules.

## Scope

* Reconcile product gallery media attachments on create/update
* Reconcile product COA media attachment on create/update
* Use `internal/media.NewAttachmentReconciler`
* Enforce store scoping and immutability rules
* Ensure attachment changes occur in the same DB transaction as product mutation

**NOT included**

* Media upload
* COA parsing or validation
* Recursive media deletion 
* Worker-based cleanup logic to remove attachment from entities

## Acceptance Criteria

* [ ] Creating a product with media IDs creates corresponding `media_attachments` rows
* [ ] Updating product media diffs old vs new media IDs and adds/removes attachment rows correctly
* [ ] Attachment reconciliation runs inside the product transaction
* [ ] No attachment rows are mutated in place (delete + recreate only)
* [ ] Cross-store attachment attempts are rejected

## Dependencies

* Blocked by: PF-251 (license ↔ media wiring patterns established)
* Blocks: None

## Technical Notes

* Services: `products`, `media`
* Tables: `products`, `media_attachments`
* Helper: `internal/media.NewAttachmentReconciler`
* Entity types: `product_gallery`, `product_coa`
* **ASSUMPTION:** Product create/update flows already load previous media IDs for diffing

## Out of Scope

* Protected attachment enforcement
* Media deletion or GCS cleanup
* UI rendering concerns

---

# Title [PF-253]: Wire store ↔ media attachments (logo and banner) using canonical reconciler

## Type

Feature

## Description

Wire store branding media (logo and banner) to the canonical media attachment lifecycle. Any update to store branding MUST reconcile attachments via the shared reconciler and apply attachment changes transactionally with the store update.

This ensures store branding media is tracked as explicit usage and cleaned up correctly when replaced or cleared.

## Scope

* Reconcile store logo attachment on create/update
* Reconcile store banner attachment on create/update
* Enforce one attachment per usage
* Run reconciliation inside the store update transaction

**NOT included**

* Image processing or resizing
* Store profile UI
* Recursive deletion logic

## Acceptance Criteria

* [ ] Setting a logo or banner creates a `media_attachments` row
* [ ] Replacing logo or banner deletes the old attachment and creates a new one
* [ ] Clearing logo or banner removes the attachment row
* [ ] Attachment reconciliation occurs in the same transaction as store update
* [ ] Media rows are never deleted as part of this flow

## Dependencies

* Blocked by: Media attachment table and reconciler availability
* Blocks: None

## Technical Notes

* Services: `stores`, `media`
* Tables: `stores`, `media_attachments`
* Helper: `internal/media.NewAttachmentReconciler`
* Entity types: `store_logo`, `store_banner`
* **ASSUMPTION:** Store model exposes nullable logo and banner media ID fields

## Out of Scope

* Branding validation rules
* CDN behavior
* Admin moderation

---

# [INCOMPLETE ❌] Title [PF-254]: Wire user ↔ media attachments (avatar) using canonical reconciler

## Type

Feature

## Description

Wire user avatar media references into the canonical media attachment lifecycle. Any change to a user avatar MUST reconcile attachments transactionally using the shared reconciler to ensure correct attachment tracking and safe deletion semantics.

## Scope

* Reconcile user avatar attachment on create/update
* Support avatar replacement and clearing
* Enforce store scoping and immutability rules
* Run reconciliation inside the user update transaction

**NOT included**

* Avatar upload UI
* Image cropping or resizing
* Media deletion worker logic

## Acceptance Criteria

* [ ] Setting an avatar creates a `media_attachments` row
* [ ] Replacing an avatar deletes the old attachment and creates a new one
* [ ] Clearing the avatar removes the attachment row
* [ ] Attachment reconciliation runs in the same DB transaction as user update
* [ ] Media rows remain intact after detachment

## Dependencies

* Blocked by: Media attachment reconciler
* Blocks: None

## Technical Notes

* Services: `users`, `media`
* Tables: `users`, `media_attachments`
* Helper: `internal/media.NewAttachmentReconciler`
* Entity type: `user_avatar`
* **ASSUMPTION:** User model supports a nullable avatar media ID

## Out of Scope

* Social profile features
* Presence or activity indicators
* Recursive cleanup

---

If you want next, the natural continuation is:

* **Phase 9: Media Deletion Worker & Protected Enforcement**
* Or a **single ADR** locking the reconciler usage as mandatory across all domains
