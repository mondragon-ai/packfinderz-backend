# Title [PF-201]: Prevent generating READ URLs for pending media

## Type

Bug

## Description

Prevent READ (download/view) URLs from being generated or returned for media records whose status is `pending`. This closes an edge case where clients can attempt to access media before upload completion or validation.

## Scope

* Block READ URL generation when `media.status = pending`
* Ensure API responses do not include READ URLs for pending media
* Return a clear, consistent error or omit READ URL fields

**Explicitly NOT included**

* Changes to upload flows
* Changes to media status transitions
* UI changes

## Acceptance Criteria

* [ ] Media with `status=pending` never returns a READ URL
* [ ] Media with `status=uploaded/ready` returns a valid READ URL
* [ ] Existing tests updated or new tests added to cover this case

## Dependencies

* Blocked by: None
* Blocks: None

## Technical Notes

* Affected areas: media service, READ URL helper
* **ASSUMPTION:** `pending` is the only pre-upload state requiring this restriction

## Out of Scope

* Authorization logic
* Signed URL expiration policy

---

# Title [PF-202]: Change GCS object key to canonical `{storeId}/{media_kind}/{mediaId}.{ext}`

## Type

Task

## Description

Change the GCS object key format to a canonical, deterministic structure based on store and media identity. This avoids filename collisions and removes reliance on user-supplied filenames.

## Scope

* Update object key generation to `{activeStoreId}/{media_kind}/{mediaId}.{ext}`
* Stop using original filenames in GCS paths
* Ensure upload and READ URL generation use the new key

**Explicitly NOT included**

* Backfilling existing objects
* Migrating previously uploaded media

## Acceptance Criteria

* [ ] New uploads use the canonical object key format
* [ ] Filenames are no longer used in GCS paths
* [ ] READ URLs resolve correctly for newly uploaded media

## Dependencies

* Blocked by: None
* Blocks: PF-203

## Technical Notes

* Media kind (`media_kind`) examples: `product`, `ads`, `license_doc`, `pdf`, `coa`, `manifest`, `user`, `store`, `other`
* **ASSUMPTION:** file extension is known and trusted at upload time

## Out of Scope

* Renaming existing GCS objects
* Client-visible filename changes


---

# Title [PF-203]: Add delete-media worker to deploy targets (Docker/Heroku/Make)

## Type

Infra

## Description

Ensure the delete-media worker binary is included in Docker images, Heroku process definitions, and Make targets so it is deployed and runnable in all environments.

## Scope

* Add worker to Docker build
* Add worker to Heroku/Procfile configuration
* Add Make targets for local execution

**Explicitly NOT included**

* Worker logic changes
* Scheduling logic

## Acceptance Criteria

* [ ] Delete-media worker builds in Docker
* [ ] Worker can be started via Make target
* [ ] Worker is deployed in Heroku environments

## Dependencies

* Blocked by: Existing delete-media worker implementation
* Blocks: PF-207, PF-208

## Technical Notes

* Binary: `cmd/media_deleted_worker`
* **ASSUMPTION:** worker uses existing config/env patterns

## Out of Scope

* Autoscaling configuration
* Monitoring setup

---

# Title [PF-204]: Add stale pending media cleanup to cron worker (7 days)

## Type

Feature

## Description

Extend the cron worker to delete media records stuck in `pending` status for more than 7 days. This prevents buildup of abandoned uploads.

## Scope

* Scan media with `status=pending` older than 7 days
* Delete media records and any associated attachments
* Log cleanup actions

**Explicitly NOT included**

* GCS object deletion for never-uploaded media
* Notifications to users

## Acceptance Criteria

* [ ] Pending media older than 7 days are deleted
* [ ] Cleanup runs as part of the daily cron worker
* [ ] Actions are logged for observability

## Dependencies

* Blocked by: PF-205
* Blocks: None

## Technical Notes

* Worker: `cmd/cron-worker/main.go`
* **ASSUMPTION:** pending media older than 7 days is always safe to delete

## Out of Scope

* Configurable retention periods
* Retry logic

---

# [INCPMPLETE ❌] Title [PF-205]: Fix media delete endpoint not deleting DB or GCS objects

## Type

Bug

## Description

Fix an issue where the media delete endpoint returns HTTP 200 but does not actually delete the media record or the underlying GCS object. Ensure end-to-end correctness and observability.

## Scope

* Verify delete flow from API → worker → GCS
* Ensure DB row deletion occurs
* Ensure GCS object deletion occurs
* Add logs for each step

**Explicitly NOT included**

* Attachment lifecycle refactors
* Retry policy changes

## Acceptance Criteria

* [ ] Deleting media removes the DB record
* [ ] Corresponding GCS object is deleted
* [ ] Logs clearly indicate success/failure at each step

## Dependencies

* Blocked by: PF-205
* Blocks: PF-208

## Technical Notes

* Validate worker execution and outcomes
* **ASSUMPTION:** delete-media worker is responsible for GCS deletion

## Out of Scope

* DLQ for failed deletions
* Soft deletes

---

# [INCPMPLETE ❌] Title [PF-206]: Detach attachment references and delete GCS artifacts on media deletion

## Type

Feature

## Description

Extend the media deletion worker to detach all `media_attachments` references by entity type and delete GCS originals and derived artifacts when no attachments remain.

## Scope

* Enumerate attachments by `media_id`
* Detach references per entity type
* Delete GCS original and derived artifacts when safe

**Explicitly NOT included**

* Domain-specific business decisions
* Re-attachment logic

## Acceptance Criteria

* [ ] All attachment rows are removed when media is deleted
* [ ] Protected attachments prevent deletion
* [ ] GCS originals and derived files are deleted only when no attachments remain

## Dependencies

* Blocked by: PF-207
* Blocks: None

## Technical Notes

* Worker: `cmd/media_deleted_worker/main.go`
* Uses `media_attachments` as source of truth
* **ASSUMPTION:** attachment protection rules are already enforced upstream

## Out of Scope

* UI updates
* Attachment backfill logic
